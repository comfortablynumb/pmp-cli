# Executors

Executors are the underlying IaC tools that manage infrastructure. PMP currently supports OpenTofu and a special "none" executor for dependency-only projects.

## Available Executors

| Executor | Description | Operations |
|----------|-------------|------------|
| `opentofu` | OpenTofu/Terraform execution | init, plan, apply, destroy, refresh, test |
| `none` | No-op executor for grouping | All operations succeed without action |

## OpenTofu Executor

The default executor for infrastructure management.

### Configuration

```yaml
# .pmp.environment.yaml
spec:
  executor:
    name: opentofu
    config:
      backend:
        type: s3
        bucket: terraform-state
        key: "${project}/${environment}/terraform.tfstate"
        region: us-west-2
        encrypt: true
        dynamodb_table: terraform-locks

      commands:
        plan:
          options:
            - "-detailed-exitcode"
        apply:
          options:
            - "-auto-approve"
```

### Supported Backends

| Backend | Type | Key Parameters |
|---------|------|----------------|
| Local | `local` | `path` |
| S3 | `s3` | `bucket`, `key`, `region`, `encrypt`, `dynamodb_table` |
| Azure | `azurerm` | `storage_account_name`, `container_name`, `key` |
| GCS | `gcs` | `bucket`, `prefix` |
| Kubernetes | `kubernetes` | `secret_suffix`, `namespace` |
| PostgreSQL | `pg` | `conn_str`, `schema_name` |
| Consul | `consul` | `path`, `address` |
| HTTP | `http` | `address`, `lock_address`, `unlock_address` |

### Backend Examples

**S3 Backend:**
```yaml
backend:
  type: s3
  bucket: my-terraform-state
  key: "projects/${_name}/${_environment}/terraform.tfstate"
  region: us-west-2
  encrypt: true
  dynamodb_table: terraform-locks
```

**Azure Backend:**
```yaml
backend:
  type: azurerm
  resource_group_name: terraform-state-rg
  storage_account_name: tfstateaccount
  container_name: tfstate
  key: "${_name}/${_environment}/terraform.tfstate"
```

**GCS Backend:**
```yaml
backend:
  type: gcs
  bucket: my-terraform-state
  prefix: "projects/${_name}/${_environment}"
```

**Kubernetes Backend:**
```yaml
backend:
  type: kubernetes
  secret_suffix: terraform-state
  namespace: terraform
  labels:
    project: "${_name}"
    environment: "${_environment}"
```

### Generated Backend File

PMP generates `_common.tf` with backend configuration:

```hcl
# Auto-generated by PMP - DO NOT EDIT
terraform {
  backend "s3" {
    bucket         = "my-terraform-state"
    key            = "my-api/dev/terraform.tfstate"
    region         = "us-west-2"
    encrypt        = true
    dynamodb_table = "terraform-locks"
  }
}
```

### Operations

| Command | Executor Operation | Description |
|---------|-------------------|-------------|
| `pmp project preview` | `tofu plan` | Preview changes |
| `pmp project apply` | `tofu apply` | Apply changes |
| `pmp project destroy` | `tofu destroy` | Destroy infrastructure |
| `pmp project refresh` | `tofu refresh` | Refresh state |
| `pmp project test` | `tofu test` | Run tests |

### Passing Executor Arguments

```bash
# Pass arguments after --
pmp project apply -- -auto-approve
pmp project preview -- -no-color -var="environment=prod"
pmp project destroy -- -target=aws_instance.main
```

## None Executor

A special executor that performs no operations. Used for dependency-only projects.

### Configuration

```yaml
# .pmp.template.yaml
spec:
  executor: none
```

### Behavior

- All operations (preview, apply, destroy, refresh) succeed immediately
- No backend configuration required
- Hooks still execute
- Useful for grouping related projects

### Use Cases

1. **Application Groups**: Bundle multiple services together
2. **Environment Deployments**: Deploy all resources for an environment
3. **Staged Rollouts**: Control deployment phases
4. **Feature Flags**: Enable/disable feature sets

### Example

```yaml
# .pmp.template.yaml - Application Stack
apiVersion: pmp.io/v1
kind: Template
metadata:
  name: "Application Stack"
spec:
  apiVersion: pmp.io/v1
  kind: ApplicationStack
  executor: none

  dependencies:
    - project:
        apiVersion: pmp.io/v1
        kind: PostgresDatabase
    - project:
        apiVersion: pmp.io/v1
        kind: RedisCache
    - project:
        apiVersion: pmp.io/v1
        kind: KubernetesWorkload
```

When you run `pmp project apply` on this stack:
1. PostgresDatabase is applied
2. RedisCache is applied
3. KubernetesWorkload is applied
4. ApplicationStack itself is skipped (no-op)

## Infrastructure-Level Executor

Set default executor for all projects:

```yaml
# .pmp.infrastructure.yaml
spec:
  executor:
    name: opentofu
    config:
      backend:
        type: s3
        bucket: terraform-state
        region: us-west-2
        encrypt: true
```

Projects inherit this configuration unless they override it.

## Command Options

Configure default command options:

```yaml
executor:
  name: opentofu
  config:
    commands:
      plan:
        options:
          - "-detailed-exitcode"
          - "-out=tfplan"
      apply:
        options:
          - "-auto-approve"
      destroy:
        options:
          - "-auto-approve"
```

These options are prepended to any arguments passed via `--`.
