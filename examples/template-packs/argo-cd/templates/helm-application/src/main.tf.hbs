terraform {
  required_providers {
    argocd = {
      source  = "argoproj-labs/argocd"
      version = "~> 6.0"
    }
  }
}

# Provider authenticates via environment variables:
# - ARGOCD_SERVER: ArgoCD server address
# - ARGOCD_AUTH_TOKEN: Authentication token
provider "argocd" {
  # Authentication handled via environment variables
}

resource "argocd_application" "app" {
  metadata {
    name      = "{{k8s_name name}}"
    namespace = "argocd"
    labels = {
      managed = "opentofu"
      project = "{{name}}"
    }
{{#if app_description}}
    annotations = {
      description = var.app_description
    }
{{/if}}
  }

  spec {
    project = var.project

    source {
      repo_url        = var.helm_repo_url
      chart           = var.chart_name
      target_revision = var.target_revision != "" ? var.target_revision : null

      helm {
{{#if helm_release_name}}
        release_name = var.helm_release_name != "" ? var.helm_release_name : "{{k8s_name name}}"
{{else}}
        release_name = "{{k8s_name name}}"
{{/if}}

{{#if helm_values}}
        values = var.helm_values
{{/if}}

{{#if helm_values_files}}
        dynamic "value_files" {
          for_each = var.helm_values_files
          content {
            value = value_files.value
          }
        }
{{/if}}

{{#if helm_parameters}}
        dynamic "parameter" {
          for_each = var.helm_parameters
          content {
            name  = parameter.value.name
            value = parameter.value.value
            force_string = lookup(parameter.value, "force_string", false)
          }
        }
{{/if}}
      }
    }

    destination {
      server    = var.destination_server
      namespace = var.destination_namespace
    }
  }

  wait = true
}
