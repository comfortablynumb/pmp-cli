terraform {
  required_providers {
    vault = {
      source  = "hashicorp/vault"
      version = "~> 3.23"
    }
  }
}

# Vault provider configuration
# Connection details are passed as variables from the parent module
# The parent module reads from the reference vault project's remote state
provider "vault" {
  address = var.vault_address
  # Authentication should be configured via VAULT_TOKEN environment variable
  skip_child_token = true
}

locals {
  # Parse secret data from JSON string
  secret_data = jsondecode(var.secret_data)

  # Full path in KV mount (using project name)
  full_secret_path = "${var.kv_mount_path}/data/{{__reference_project_name}}"
}

# Create or update secret in KV v2
resource "vault_kv_secret_v2" "secret" {
  mount = var.kv_mount_path
  name  = "{{__reference_project_name}}"

  # CAS parameter for check-and-set operations
  cas = var.cas

  # Secret data
  data_json = var.secret_data

  # Delete all versions on destroy if configured
  delete_all_versions = var.delete_all_versions
}

# Create policy to manage this project's secret
resource "vault_policy" "secret_policy" {
  name = "{{__reference_project_name}}"

  policy = <<-EOT
    # Allow full access to this project's secret
    path "${var.kv_mount_path}/data/{{__reference_project_name}}" {
      capabilities = ["create", "read", "update", "delete", "list", "patch"]
    }

    # Allow read access to secret metadata
    path "${var.kv_mount_path}/metadata/{{__reference_project_name}}" {
      capabilities = ["read", "list"]
    }

    # Allow delete and undelete of secret versions
    path "${var.kv_mount_path}/delete/{{__reference_project_name}}" {
      capabilities = ["update"]
    }

    path "${var.kv_mount_path}/undelete/{{__reference_project_name}}" {
      capabilities = ["update"]
    }

    # Allow destroying secret versions
    path "${var.kv_mount_path}/destroy/{{__reference_project_name}}" {
      capabilities = ["update"]
    }
  EOT
}

# Create Kubernetes auth backend role for this project
resource "vault_kubernetes_auth_backend_role" "secret_role" {
  backend   = var.kubernetes_auth_path
  role_name = "{{__reference_project_name}}"

  # Bind to the policy created above
  bound_service_account_names      = var.kubernetes_service_accounts
  bound_service_account_namespaces = var.kubernetes_namespaces

  # Attach the policy
  token_policies = [vault_policy.secret_policy.name]

  # Token TTL settings
  token_ttl     = var.token_ttl
  token_max_ttl = var.token_max_ttl
}
