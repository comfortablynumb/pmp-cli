terraform {
  required_providers {
    vault = {
      source  = "hashicorp/vault"
      version = "~> 3.23"
    }
  }
}

# Vault provider configuration
# Connection details are passed as variables from the parent module
# The parent module reads from the reference vault project's remote state
provider "vault" {
  address = var.vault_address
  # Authentication should be configured via VAULT_TOKEN environment variable
  skip_child_token = true
}

locals {
  # Parse secret data from JSON string
  secret_data = jsondecode(var.secret_data)

  # Full path in KV mount
  full_secret_path = "${var.kv_mount_path}/data/${var.secret_path}"
}

# Create or update secret in KV v2
resource "vault_kv_secret_v2" "secret" {
  mount = var.kv_mount_path
  name  = var.secret_path

  # CAS parameter for check-and-set operations
  cas = var.cas

  # Secret data
  data_json = var.secret_data

  # Delete all versions on destroy if configured
  delete_all_versions = var.delete_all_versions
}
