output "secret_path" {
  description = "Full path to the secret in Vault"
  value       = "${var.kv_mount_path}/data/${var.secret_path}"
}

output "secret_metadata_path" {
  description = "Path to secret metadata in Vault"
  value       = "${var.kv_mount_path}/metadata/${var.secret_path}"
}

output "secret_version" {
  description = "Version of the secret"
  value       = vault_kv_secret_v2.secret.metadata[0].version
}

output "secret_created_time" {
  description = "Timestamp when the secret was created"
  value       = vault_kv_secret_v2.secret.metadata[0].created_time
}

output "vault_address" {
  description = "Vault server address"
  value       = var.vault_address
}

output "kv_mount_path" {
  description = "KV v2 mount path"
  value       = var.kv_mount_path
}

output "usage_notes" {
  description = "Important usage information"
  value = <<-EOT
    VAULT SECRET CREATED
    ====================

    Secret Path: ${var.secret_path}
    Full Path: ${var.kv_mount_path}/data/${var.secret_path}
    Version: ${vault_kv_secret_v2.secret.metadata[0].version}
    KV Mount: ${var.kv_mount_path}

    VAULT ACCESS:
    - Address: ${var.vault_address}
    - Path: ${var.kv_mount_path}/data/${var.secret_path}

    READ SECRET (CLI):
    # Set Vault address and authenticate
    export VAULT_ADDR="${var.vault_address}"
    vault login <token>

    # Read the secret
    vault kv get -mount=${var.kv_mount_path} ${var.secret_path}

    # Read specific version
    vault kv get -version=${vault_kv_secret_v2.secret.metadata[0].version} -mount=${var.kv_mount_path} ${var.secret_path}

    READ SECRET (API):
    curl -H "X-Vault-Token: <token>" ${var.vault_address}/v1/${var.kv_mount_path}/data/${var.secret_path}

    VAULT AGENT INJECTOR (Kubernetes):
    Add these annotations to your pod spec to inject this secret:
      vault.hashicorp.com/agent-inject: "true"
      vault.hashicorp.com/role: "<your-role>"
      vault.hashicorp.com/agent-inject-secret-config: "${var.kv_mount_path}/data/${var.secret_path}"
      vault.hashicorp.com/agent-inject-template-config: |
        {{{{- with secret "${var.kv_mount_path}/data/${var.secret_path}" -}}}}
        {{{{- range $k, $v := .Data.data }}}}
        export {{{{ $k }}}}="{{{{ $v }}}}"
        {{{{- end }}}}
        {{{{- end }}}}
  EOT
}

output "environments" {
  description = "Environment variables map for K8s deployment consumption"
  value = {
    "PLUGIN_VAULT_SECRET_${replace(upper("{{__reference_project_name}}"), "/[^A-Z0-9]/", "_")}_VAULT_ADDR" = {
      value = var.vault_address
    }
    "PLUGIN_VAULT_SECRET_${replace(upper("{{__reference_project_name}}"), "/[^A-Z0-9]/", "_")}_SECRET_PATH" = {
      value = "${var.kv_mount_path}/data/${var.secret_path}"
    }
    "PLUGIN_VAULT_SECRET_${replace(upper("{{__reference_project_name}}"), "/[^A-Z0-9]/", "_")}_KV_MOUNT" = {
      value = var.kv_mount_path
    }
  }
  sensitive = false
}

output "secret_metadata" {
  description = "Secret metadata summary"
  value = {
    path         = var.secret_path
    full_path    = "${var.kv_mount_path}/data/${var.secret_path}"
    mount        = var.kv_mount_path
    version      = vault_kv_secret_v2.secret.metadata[0].version
    created_time = vault_kv_secret_v2.secret.metadata[0].created_time
    vault_addr   = var.vault_address
  }
}
