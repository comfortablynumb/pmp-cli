output "secret_path" {
  description = "Full path to the secret in Vault"
  value       = "${var.kv_mount_path}/data/{{__reference_project_name}}"
}

output "secret_metadata_path" {
  description = "Path to secret metadata in Vault"
  value       = "${var.kv_mount_path}/metadata/{{__reference_project_name}}"
}

output "secret_version" {
  description = "Version of the secret"
  value       = vault_kv_secret_v2.secret.metadata[0].version
}

output "secret_created_time" {
  description = "Timestamp when the secret was created"
  value       = vault_kv_secret_v2.secret.metadata[0].created_time
}

output "vault_address" {
  description = "Vault server address"
  value       = var.vault_address
}

output "kv_mount_path" {
  description = "KV v2 mount path"
  value       = var.kv_mount_path
}

output "usage_notes" {
  description = "Important usage information"
  value = <<-EOT
    VAULT SECRET CREATED
    ====================

    Project: {{__reference_project_name}}
    Full Path: ${var.kv_mount_path}/data/{{__reference_project_name}}
    Version: ${vault_kv_secret_v2.secret.metadata[0].version}
    KV Mount: ${var.kv_mount_path}
    Role: {{__reference_project_name}}
    Policy: {{__reference_project_name}}

    VAULT ACCESS:
    - Address: ${var.vault_address}
    - Path: ${var.kv_mount_path}/data/{{__reference_project_name}}

    READ SECRET (CLI):
    # Set Vault address and authenticate
    export VAULT_ADDR="${var.vault_address}"
    vault login <token>

    # Read the secret
    vault kv get -mount=${var.kv_mount_path} {{__reference_project_name}}

    # Read specific version
    vault kv get -version=${vault_kv_secret_v2.secret.metadata[0].version} -mount=${var.kv_mount_path} {{__reference_project_name}}

    READ SECRET (API):
    curl -H "X-Vault-Token: <token>" ${var.vault_address}/v1/${var.kv_mount_path}/data/{{__reference_project_name}}

    VAULT AGENT INJECTOR (Kubernetes):
    Add these annotations to your pod spec to inject this secret:
      vault.hashicorp.com/agent-inject: "true"
      vault.hashicorp.com/role: "{{__reference_project_name}}"
      vault.hashicorp.com/agent-inject-secret-config: "${var.kv_mount_path}/data/{{__reference_project_name}}"
      vault.hashicorp.com/agent-inject-template-config: |
        {{{{- with secret "${var.kv_mount_path}/data/{{__reference_project_name}}" -}}}}
        {{{{- range $k, $v := .Data.data }}}}
        export {{{{ $k }}}}="{{{{ $v }}}}"
        {{{{- end }}}}
        {{{{- end }}}}
  EOT
}

output "environments" {
  description = "Environment variables map for K8s deployment consumption"
  value = {
    "PLUGIN_VAULT_SECRET_${replace(upper("{{__reference_project_name}}"), "/[^A-Z0-9]/", "_")}_VAULT_ADDR" = {
      value = var.vault_address
    }
    "PLUGIN_VAULT_SECRET_${replace(upper("{{__reference_project_name}}"), "/[^A-Z0-9]/", "_")}_SECRET_PATH" = {
      value = "${var.kv_mount_path}/data/{{__reference_project_name}}"
    }
    "PLUGIN_VAULT_SECRET_${replace(upper("{{__reference_project_name}}"), "/[^A-Z0-9]/", "_")}_KV_MOUNT" = {
      value = var.kv_mount_path
    }
  }
  sensitive = false
}

output "secret_metadata" {
  description = "Secret metadata summary"
  value = {
    project      = "{{__reference_project_name}}"
    full_path    = "${var.kv_mount_path}/data/{{__reference_project_name}}"
    mount        = var.kv_mount_path
    version      = vault_kv_secret_v2.secret.metadata[0].version
    created_time = vault_kv_secret_v2.secret.metadata[0].created_time
    vault_addr   = var.vault_address
    role         = vault_kubernetes_auth_backend_role.secret_role.role_name
    policy       = vault_policy.secret_policy.name
  }
}

output "kubernetes_pod_annotations" {
  description = "Kubernetes pod annotations for Vault agent injection"
  value = {
    "vault.hashicorp.com/agent-inject" = "true"
    "vault.hashicorp.com/role"         = vault_kubernetes_auth_backend_role.secret_role.role_name
    "vault.hashicorp.com/agent-inject-secret-{{__reference_project_name}}" = "${var.kv_mount_path}/data/{{__reference_project_name}}"
  }
}
