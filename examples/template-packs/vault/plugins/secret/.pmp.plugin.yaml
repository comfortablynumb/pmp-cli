apiVersion: pmp.io/v1
kind: Plugin
metadata:
  name: secret
  description: Create and manage secrets in Vault KV v2 secret engine

spec:
  role: secret-management

  # This plugin requires a reference to a Vault project
  requires_project_with_template:
    apiVersion: pmp.io/v1
    kind: KubernetesWorkload

    # Remote state configuration - maps reference project outputs to plugin module parameters
    remote_state:
      required_fields:
        kv_mount_path: {}  # Path to the KV v2 mount
        vault_address: {}  # Vault server address

  inputs:
    secret_path:
      description: Path within the KV mount where the secret will be stored (e.g., 'myapp/config')
      # No default - required input

    secret_data:
      description: Secret data as a JSON object (e.g., '{"username":"admin","password":"secret"}')
      default: "{}"

    cas:
      description: Check-and-Set version for secret updates (0 for new secrets, specific version for updates)
      default: 0

    delete_all_versions:
      description: Delete all versions of the secret when applying destroy
      default: false

    kubernetes_auth_path:
      description: Path to the Kubernetes auth backend in Vault
      default: kubernetes

    kubernetes_service_accounts:
      description: List of Kubernetes service accounts allowed to use this role (comma-separated)
      default: "*"

    kubernetes_namespaces:
      description: List of Kubernetes namespaces where the service accounts are located (comma-separated)
      # No default - required input

    token_ttl:
      description: TTL for tokens issued by this role (in seconds)
      default: 3600

    token_max_ttl:
      description: Maximum TTL for tokens issued by this role (in seconds)
      default: 86400
