terraform {
  required_providers {
    kubernetes = {
      source  = "hashicorp/kubernetes"
      version = "~> 2.23"
    }
    helm = {
      source  = "hashicorp/helm"
      version = "~> 2.11"
    }
    vault = {
      source  = "hashicorp/vault"
      version = "~> 3.23"
    }
  }
}

provider "kubernetes" {
  config_path = "~/.kube/config"
}

provider "helm" {
  kubernetes {
    config_path = "~/.kube/config"
  }
}

# Vault provider configuration
# Note: Requires Vault to be initialized and unsealed before applying KV mount
# The VAULT_ADDR and VAULT_TOKEN environment variables must be set
provider "vault" {
  # Address will be set via VAULT_ADDR environment variable
  # Example: export VAULT_ADDR="http://vault.{{namespace}}.svc.cluster.local:8200"
  skip_child_token = true
}

{{#if create_namespace}}
resource "kubernetes_namespace" "vault" {
  metadata {
    name = var.namespace
    labels = {
      name    = var.namespace
      managed = "opentofu"
      project = "{{name}}"
    }
  }
}
{{/if}}

resource "helm_release" "vault" {
  name       = "vault"
  repository = "https://helm.releases.hashicorp.com"
  chart      = "vault"
  version    = var.chart_version
  namespace  = var.namespace

{{#if create_namespace}}
  depends_on = [kubernetes_namespace.vault]
{{/if}}

  values = [
    yamlencode({
      server = {
        {{#if ha_enabled}}
        ha = {
          enabled  = true
          replicas = var.server_replicas

          raft = {
            enabled = true
            setNodeId = true

            config = <<-EOT
              ui = ${var.ui_enabled}

              listener "tcp" {
                tls_disable = ${!var.enable_tls}
                address     = "[::]:8200"
                cluster_address = "[::]:8201"
              }

              storage "raft" {
                path = "/vault/data"
              }

              service_registration "kubernetes" {}
            EOT
          }
        }

        dataStorage = {
          enabled      = true
          size         = var.storage_size
          storageClass = null
          accessMode   = "ReadWriteOnce"
        }

        {{else}}
        standalone = {
          enabled = true

          config = <<-EOT
            ui = ${var.ui_enabled}

            listener "tcp" {
              tls_disable = ${!var.enable_tls}
              address     = "[::]:8200"
              cluster_address = "[::]:8201"
            }

            storage "file" {
              path = "/vault/data"
            }
          EOT
        }

        dataStorage = {
          enabled      = true
          size         = var.storage_size
          storageClass = null
          accessMode   = "ReadWriteOnce"
        }
        {{/if}}

        resources = {
          requests = {
            cpu    = var.resources_requests_cpu
            memory = var.resources_requests_memory
          }
          limits = {
            cpu    = var.resources_limits_cpu
            memory = var.resources_limits_memory
          }
        }

        service = {
          enabled = true
          type    = var.ui_service_type
          port    = 8200
        }

{{#if enable_ingress}}
        ingress = {
          enabled          = true
          ingressClassName = var.ingress_class
          {{#if ingress_host}}
          hosts = [{
            host = var.ingress_host
            paths = [{
              path     = "/"
              pathType = "Prefix"
            }]
          }]
          {{/if}}
          {{#if enable_tls}}
          tls = var.ingress_host != "" ? [{
            secretName = "vault-tls"
            hosts      = [var.ingress_host]
          }] : []
          {{/if}}
        }
{{/if}}

        extraEnvironmentVars = {
          VAULT_ADDR      = "http://127.0.0.1:8200"
          VAULT_LOG_LEVEL = "info"
        }
      }

      ui = {
        enabled       = var.ui_enabled
        serviceType   = var.ui_service_type
      }

      {{#if injector_enabled}}
      injector = {
        enabled  = true
        replicas = var.injector_replicas

        resources = {
          requests = {
            cpu    = "50m"
            memory = "64Mi"
          }
          limits = {
            cpu    = "100m"
            memory = "128Mi"
          }
        }

        extraEnvironmentVars = {
          AGENT_INJECT_VAULT_ADDR = "http://vault.${var.namespace}.svc:8200"
        }
      }
      {{else}}
      injector = {
        enabled = false
      }
      {{/if}}
    })
  ]

  # Wait for deployment to be ready
  wait    = true
  timeout = 600
}

# Create KV v2 mount for this environment
# Note: This resource will be created after Vault is initialized and unsealed
resource "vault_mount" "kv" {
  path        = "kv-{{environment}}"
  type        = "kv-v2"
  description = "KV Version 2 secret engine for {{environment}} environment"

  options = {
    version = "2"
  }

  depends_on = [helm_release.vault]
}
