terraform {
  required_version = ">= 1.0"

  required_providers {
    github = {
      source  = "integrations/github"
      version = "~> 6.0"
    }
  }
}

# GitHub provider configuration
# Authentication via GITHUB_TOKEN and GITHUB_OWNER environment variables
provider "github" {
  # token = var.github_token  # Optional: Use environment variable GITHUB_TOKEN instead
  # owner = var.github_owner  # Optional: Use environment variable GITHUB_OWNER instead
}

# Main repository resource
resource "github_repository" "repo" {
  name        = var.repository_name
  description = var.description
  visibility  = var.visibility

  {{#if homepage_url}}
  homepage_url = var.homepage_url
  {{/if}}

  # Repository features
  has_issues      = var.has_issues
  has_wiki        = var.has_wiki
  has_projects    = var.has_projects
  has_discussions = var.has_discussions
  has_downloads   = var.has_downloads

  # Initialization
  auto_init = var.auto_init

  {{#if gitignore_template}}
  gitignore_template = var.gitignore_template
  {{/if}}

  {{#if license_template}}
  license_template = var.license_template
  {{/if}}

  # Merge settings
  allow_merge_commit  = var.allow_merge_commit
  allow_squash_merge  = var.allow_squash_merge
  allow_rebase_merge  = var.allow_rebase_merge
  allow_auto_merge    = var.allow_auto_merge
  delete_branch_on_merge = var.delete_branch_on_merge

  # Topics
  {{#if topics}}
  topics = [for topic in split(",", var.topics) : trimspace(topic) if trimspace(topic) != ""]
  {{/if}}

  # Metadata
  is_template = var.is_template
  archived    = var.archived

  # Security
  vulnerability_alerts = var.vulnerability_alerts

  lifecycle {
    prevent_destroy = false
  }
}

# Set default branch if different from "main"
{{#if (ne default_branch "main")}}
resource "github_branch_default" "default" {
  repository = github_repository.repo.name
  branch     = var.default_branch

  depends_on = [github_repository.repo]
}
{{/if}}
