{{#if (eq enable_branch_protection "true")}}
# Branch protection for default branch
resource "github_branch_protection" "default_branch" {
  repository_id = github_repository.repo.node_id
  pattern       = var.default_branch

  {{#if (eq require_pull_request_reviews "true")}}
  # Pull request reviews
  required_pull_request_reviews {
    dismiss_stale_reviews           = var.dismiss_stale_reviews
    require_code_owner_reviews      = var.require_code_owner_reviews
    required_approving_review_count = var.required_approving_review_count
  }
  {{/if}}

  {{#if (eq require_status_checks "true")}}
  # Status checks
  required_status_checks {
    strict = true
    {{#if status_check_contexts}}
    contexts = [for ctx in split(",", var.status_check_contexts) : trimspace(ctx) if trimspace(ctx) != ""]
    {{/if}}
  }
  {{/if}}

  # Other protection settings
  enforce_admins         = var.enforce_admins
  require_signed_commits = var.require_signed_commits
  {{#if (eq require_linear_history "true")}}
  require_linear_history = true
  {{/if}}

  # Allow force pushes and deletions are disabled by default
  allows_force_pushes = false
  allows_deletions    = false

  depends_on = [
    github_repository.repo
    {{#if (ne default_branch "main")}}
    , github_branch_default.default
    {{/if}}
  ]
}
{{/if}}
