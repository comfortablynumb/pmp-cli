terraform {
  required_version = ">= 1.0"

  required_providers {
    github = {
      source  = "integrations/github"
      version = "~> 6.0"
    }
  }
}

# GitHub repository resource
resource "github_repository" "plugin_repo" {
  name        = var.project_name
  description = var.project_description
  visibility  = var.visibility

  # Repository features (opinionated defaults for app repositories)
  has_issues      = var.has_issues
  has_wiki        = var.has_wiki
  has_projects    = var.has_projects
  has_discussions = false
  has_downloads   = true

  # Initialization
  auto_init = true

  {{#if gitignore_template}}
  gitignore_template = var.gitignore_template
  {{/if}}

  {{#if license_template}}
  license_template = var.license_template
  {{/if}}

  # Merge settings (opinionated for development workflow)
  allow_merge_commit  = true
  allow_squash_merge  = true
  allow_rebase_merge  = true
  allow_auto_merge    = false
  delete_branch_on_merge = var.delete_branch_on_merge

  # Metadata
  is_template = false
  archived    = false

  # Security
  vulnerability_alerts = true

  lifecycle {
    prevent_destroy = false
  }
}

# Set default branch if different from "main"
{{#if (ne default_branch "main")}}
resource "github_branch_default" "plugin_default" {
  repository = github_repository.plugin_repo.name
  branch     = var.default_branch

  depends_on = [github_repository.plugin_repo]
}
{{/if}}
