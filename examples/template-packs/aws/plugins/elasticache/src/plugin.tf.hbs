terraform {
  required_version = ">= 1.0"

  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
    random = {
      source  = "hashicorp/random"
      version = "~> 3.0"
    }
  }
}

locals {
  subnet_ids_list = var.subnet_ids != "" ? split(",", var.subnet_ids) : []
  security_group_ids_list = var.security_group_ids != "" ? split(",", var.security_group_ids) : []
  is_redis = var.engine == "redis"

  # Generate a unique cluster identifier
  cluster_id = replace(lower(var.project_name), "_", "-")
}

{{#if auth_token_enabled}}
# Random auth token for Redis authentication
resource "random_password" "plugin_elasticache_auth_token" {
  length  = 32
  special = true
  override_special = "!&#$^<>-"
}
{{/if}}

# Subnet group for ElastiCache
resource "aws_elasticache_subnet_group" "plugin_elasticache" {
  count       = length(local.subnet_ids_list) > 0 ? 1 : 0
  name        = "${local.cluster_id}-subnet-group"
  subnet_ids  = local.subnet_ids_list
  description = "Subnet group for ${var.project_name} ElastiCache cluster"

  tags = {
    Name      = "${var.project_name}-subnet-group"
    ManagedBy = "pmp"
    Plugin    = "aws/elasticache"
  }
}

# Parameter group for cache configuration
resource "aws_elasticache_parameter_group" "plugin_elasticache" {
  name   = "${local.cluster_id}-params"
  family = var.parameter_group_family

  {{#if (eq engine "redis")}}
  # Redis-specific parameters
  parameter {
    name  = "maxmemory-policy"
    value = "allkeys-lru"
  }
  {{/if}}

  tags = {
    Name      = "${var.project_name}-params"
    ManagedBy = "pmp"
    Plugin    = "aws/elasticache"
  }

  lifecycle {
    create_before_destroy = true
  }
}

{{#if (eq engine "redis")}}
# Redis cluster
resource "aws_elasticache_cluster" "plugin_elasticache" {
  cluster_id           = local.cluster_id
  engine               = var.engine
  engine_version       = var.engine_version
  node_type            = var.node_type
  num_cache_nodes      = var.num_cache_nodes
  parameter_group_name = aws_elasticache_parameter_group.plugin_elasticache.name
  port                 = var.port

  # Security
  subnet_group_name    = length(local.subnet_ids_list) > 0 ? aws_elasticache_subnet_group.plugin_elasticache[0].name : null
  security_group_ids   = local.security_group_ids_list

  # Encryption settings (Redis only)
  at_rest_encryption_enabled = var.at_rest_encryption_enabled
  transit_encryption_enabled = var.transit_encryption_enabled

  {{#if auth_token_enabled}}
  auth_token = random_password.plugin_elasticache_auth_token.result
  {{/if}}

  # Backup settings
  snapshot_retention_limit = var.snapshot_retention_limit
  snapshot_window          = var.snapshot_window

  # Maintenance
  maintenance_window       = var.maintenance_window
  auto_minor_version_upgrade = var.auto_minor_version_upgrade

  # Logging
  log_delivery_configuration {
    destination      = aws_cloudwatch_log_group.plugin_elasticache_slow_log.name
    destination_type = "cloudwatch-logs"
    log_format       = "json"
    log_type         = "slow-log"
  }

  log_delivery_configuration {
    destination      = aws_cloudwatch_log_group.plugin_elasticache_engine_log.name
    destination_type = "cloudwatch-logs"
    log_format       = "json"
    log_type         = "engine-log"
  }

  tags = {
    Name      = var.project_name
    ManagedBy = "pmp"
    Plugin    = "aws/elasticache"
  }

  lifecycle {
    prevent_destroy = false
  }
}

# CloudWatch Log Groups for Redis
resource "aws_cloudwatch_log_group" "plugin_elasticache_slow_log" {
  name              = "/aws/elasticache/${local.cluster_id}/slow-log"
  retention_in_days = 7

  tags = {
    Name      = "${var.project_name}-slow-log"
    ManagedBy = "pmp"
    Plugin    = "aws/elasticache"
  }
}

resource "aws_cloudwatch_log_group" "plugin_elasticache_engine_log" {
  name              = "/aws/elasticache/${local.cluster_id}/engine-log"
  retention_in_days = 7

  tags = {
    Name      = "${var.project_name}-engine-log"
    ManagedBy = "pmp"
    Plugin    = "aws/elasticache"
  }
}
{{else}}
# Memcached cluster
resource "aws_elasticache_cluster" "plugin_elasticache" {
  cluster_id           = local.cluster_id
  engine               = var.engine
  engine_version       = var.engine_version
  node_type            = var.node_type
  num_cache_nodes      = var.num_cache_nodes
  parameter_group_name = aws_elasticache_parameter_group.plugin_elasticache.name
  port                 = var.port

  # Security
  subnet_group_name  = length(local.subnet_ids_list) > 0 ? aws_elasticache_subnet_group.plugin_elasticache[0].name : null
  security_group_ids = local.security_group_ids_list

  # Maintenance
  maintenance_window         = var.maintenance_window
  auto_minor_version_upgrade = var.auto_minor_version_upgrade

  tags = {
    Name      = var.project_name
    ManagedBy = "pmp"
    Plugin    = "aws/elasticache"
  }

  lifecycle {
    prevent_destroy = false
  }
}
{{/if}}
