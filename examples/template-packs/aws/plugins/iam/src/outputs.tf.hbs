output "role_name" {
  description = "IAM role name"
  value       = aws_iam_role.plugin_iam.name
}

output "role_arn" {
  description = "ARN of the IAM role"
  value       = aws_iam_role.plugin_iam.arn
}

output "role_id" {
  description = "Unique ID of the IAM role"
  value       = aws_iam_role.plugin_iam.id
}

output "role_unique_id" {
  description = "Unique ID assigned by AWS"
  value       = aws_iam_role.plugin_iam.unique_id
}

{{#if (or (eq role_type "ec2") create_instance_profile)}}
output "instance_profile_name" {
  description = "Instance profile name"
  value       = aws_iam_instance_profile.plugin_iam.name
}

output "instance_profile_arn" {
  description = "ARN of the instance profile"
  value       = aws_iam_instance_profile.plugin_iam.arn
}
{{/if}}

# Connection information
output "connection_info" {
  description = "How to use this IAM role"
  value = <<-EOT
    IAM Role: ${aws_iam_role.plugin_iam.name}
    ARN: ${aws_iam_role.plugin_iam.arn}
    Type: ${var.role_type}

    {{#if (eq role_type "service")}}
    # Service Role for: ${local.actual_service_principal}

    # Use in AWS service configuration:
    Role ARN: ${aws_iam_role.plugin_iam.arn}

    {{else if (eq role_type "ec2")}}
    # EC2 Instance Role

    # Attach to EC2 instance:
    resource "aws_instance" "example" {
      ...
      iam_instance_profile = "${aws_iam_instance_profile.plugin_iam.name}"
    }

    # Or use in Launch Template:
    resource "aws_launch_template" "example" {
      ...
      iam_instance_profile {
        arn = "${aws_iam_instance_profile.plugin_iam.arn}"
      }
    }

    {{else if (eq role_type "cross-account")}}
    # Cross-Account Role

    # Assume role from trusted accounts:
    {{#each trusted_account_ids_list}}
    - Account: {{this}}
    {{/each}}

    # AWS CLI assume role:
    aws sts assume-role \
      --role-arn ${aws_iam_role.plugin_iam.arn} \
      --role-session-name MySession{{#if require_mfa}} \
      --serial-number <MFA_DEVICE_ARN> \
      --token-code <MFA_CODE>{{/if}}

    {{else if (eq role_type "oidc")}}
    # OIDC Federated Role (e.g., GitHub Actions)

    # GitHub Actions workflow example:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${aws_iam_role.plugin_iam.arn}
        aws-region: ${data.aws_region.current.name}

    {{else if (eq role_type "user")}}
    # User Role

    # Assume role from trusted users:
    {{#each trusted_user_arns_list}}
    - User: {{this}}
    {{/each}}

    # AWS CLI assume role:
    aws sts assume-role \
      --role-arn ${aws_iam_role.plugin_iam.arn} \
      --role-session-name MySession
    {{/if}}

    # Permissions Granted:
    {{#if attach_readonly_policy}}- ReadOnlyAccess (AWS Managed){{/if}}
    {{#if attach_poweruser_policy}}- PowerUserAccess (AWS Managed){{/if}}
    {{#if enable_s3_access}}- S3 Access (${var.s3_access_level}){{/if}}
    {{#if enable_dynamodb_access}}- DynamoDB Access (${var.dynamodb_access_level}){{/if}}
    {{#if enable_secrets_manager_access}}- Secrets Manager Access{{/if}}
    {{#if enable_cloudwatch_logs}}- CloudWatch Logs Access{{/if}}
    {{#if enable_sqs_access}}- SQS Access{{/if}}
    {{#if enable_sns_access}}- SNS Access{{/if}}
    {{#if enable_kms_access}}- KMS Access{{/if}}
    {{#if enable_custom_policy}}- Custom Policy{{/if}}

    # View role in console:
    https://console.aws.amazon.com/iam/home?region=${data.aws_region.current.name}#/roles/${aws_iam_role.plugin_iam.name}
  EOT
}

# Usage examples by service
output "usage_examples" {
  description = "Service-specific usage examples"
  value = <<-EOT
    {{#if (eq service_principal "lambda.amazonaws.com")}}
    # Lambda Function:
    resource "aws_lambda_function" "example" {
      function_name = "my-function"
      role          = "${aws_iam_role.plugin_iam.arn}"
      ...
    }

    {{else if (eq service_principal "ecs-tasks.amazonaws.com")}}
    # ECS Task Definition:
    resource "aws_ecs_task_definition" "example" {
      family             = "my-task"
      task_role_arn      = "${aws_iam_role.plugin_iam.arn}"
      execution_role_arn = "<EXECUTION_ROLE_ARN>"
      ...
    }

    {{else if (eq service_principal "states.amazonaws.com")}}
    # Step Functions State Machine:
    resource "aws_sfn_state_machine" "example" {
      name     = "my-state-machine"
      role_arn = "${aws_iam_role.plugin_iam.arn}"
      ...
    }

    {{else if (eq service_principal "events.amazonaws.com")}}
    # EventBridge Rule:
    resource "aws_cloudwatch_event_rule" "example" {
      name        = "my-rule"
      description = "Trigger on schedule"
      ...
    }

    resource "aws_cloudwatch_event_target" "example" {
      rule      = aws_cloudwatch_event_rule.example.name
      target_id = "MyTarget"
      arn       = "<TARGET_ARN>"
      role_arn  = "${aws_iam_role.plugin_iam.arn}"
    }

    {{else if (eq service_principal "glue.amazonaws.com")}}
    # Glue Job:
    resource "aws_glue_job" "example" {
      name     = "my-glue-job"
      role_arn = "${aws_iam_role.plugin_iam.arn}"
      ...
    }
    {{/if}}

    # Python SDK - Assume Role:
    import boto3

    sts_client = boto3.client('sts')
    assumed_role = sts_client.assume_role(
        RoleArn='${aws_iam_role.plugin_iam.arn}',
        RoleSessionName='MySession'
    )

    credentials = assumed_role['Credentials']
    session = boto3.Session(
        aws_access_key_id=credentials['AccessKeyId'],
        aws_secret_access_key=credentials['SecretAccessKey'],
        aws_session_token=credentials['SessionToken']
    )
  EOT
}

# Security best practices
output "security_notes" {
  description = "Security considerations for this role"
  value = <<-EOT
    Security Best Practices:

    1. Least Privilege:
       ✓ Grant only the permissions needed
       ✓ Review and remove unused permissions regularly
       {{#if attach_poweruser_policy}}⚠ PowerUserAccess is broad - consider restricting{{/if}}

    2. Session Duration:
       Current: ${var.max_session_duration} seconds (${var.max_session_duration / 3600} hours)
       {{#if (gt max_session_duration 3600)}}⚠ Consider shorter sessions for sensitive roles{{/if}}

    3. Trust Relationships:
       {{#if (eq role_type "cross-account")}}
       {{#if require_mfa}}✓ MFA is required{{else}}⚠ Consider requiring MFA{{/if}}
       {{/if}}
       ✓ Review trusted principals regularly

    4. Monitoring:
       # Enable CloudTrail to monitor role usage:
       aws cloudtrail lookup-events \
         --lookup-attributes AttributeKey=ResourceName,AttributeValue=${aws_iam_role.plugin_iam.arn}

    5. Policy Boundaries:
       Consider using permissions boundaries for additional protection:
       aws iam put-role-permissions-boundary \
         --role-name ${aws_iam_role.plugin_iam.name} \
         --permissions-boundary <BOUNDARY_POLICY_ARN>

    6. Regular Audits:
       # View role's last activity:
       aws iam get-role --role-name ${aws_iam_role.plugin_iam.name}

       # List attached policies:
       aws iam list-attached-role-policies --role-name ${aws_iam_role.plugin_iam.name}
       aws iam list-role-policies --role-name ${aws_iam_role.plugin_iam.name}
  EOT
}
