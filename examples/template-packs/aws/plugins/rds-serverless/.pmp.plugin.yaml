apiVersion: pmp.io/v1
kind: Plugin
metadata:
  name: rds-serverless
  description: Create AWS RDS Aurora Serverless cluster with automatic scaling, high availability, and automated backups for PostgreSQL or MySQL workloads

spec:
  role: serverless-database

  inputs:
    # Project Metadata
    - name: project_name
      type: string
      description: Database cluster identifier (defaults to project name)
      default: ""

    # Engine Configuration
    - name: engine
      type: select
      options:
        - label: "Aurora PostgreSQL Serverless v2"
          value: "aurora-postgresql"
        - label: "Aurora MySQL Serverless v2"
          value: "aurora-mysql"
      default: "aurora-postgresql"
      description: Database engine type

    - name: engine_version
      type: select
      options:
        - label: "PostgreSQL 15.5 (Latest)"
          value: "15.5"
        - label: "PostgreSQL 14.10"
          value: "14.10"
        - label: "PostgreSQL 13.13"
          value: "13.13"
        - label: "MySQL 8.0.mysql_aurora.3.05.2"
          value: "8.0.mysql_aurora.3.05.2"
        - label: "MySQL 8.0.mysql_aurora.3.04.1"
          value: "8.0.mysql_aurora.3.04.1"
      default: "15.5"
      description: Database engine version

    # Database Configuration
    - name: database_name
      type: string
      description: Initial database name to create
      default: "mydb"

    - name: master_username
      type: string
      description: Master username for database access
      default: "dbadmin"

    # Serverless v2 Scaling Configuration
    - name: serverless_min_capacity
      type: number
      description: Minimum ACUs (Aurora Capacity Units) - 0.5 to 128
      default: 0.5
      min: 0.5
      max: 128

    - name: serverless_max_capacity
      type: number
      description: Maximum ACUs (Aurora Capacity Units) - 0.5 to 128
      default: 2
      min: 0.5
      max: 128

    # High Availability
    - name: availability_zones
      type: string
      description: Comma-separated availability zones (leave empty for automatic selection)
      default: ""

    # Instance Configuration
    - name: instance_count
      type: number
      description: Number of Aurora Serverless v2 instances (1 for single-AZ, 2+ for Multi-AZ)
      default: 2
      min: 1
      max: 15

    # Network Configuration
    - name: vpc_id
      type: string
      description: VPC ID for the database cluster
      default: ""

    - name: subnet_ids
      type: string
      description: Comma-separated subnet IDs for DB subnet group (minimum 2 in different AZs)
      default: ""

    - name: security_group_ids
      type: string
      description: Comma-separated security group IDs
      default: ""

    - name: publicly_accessible
      type: boolean
      description: Make database publicly accessible (not recommended for production)
      default: false

    # Backup Configuration
    - name: backup_retention_period
      type: number
      description: Backup retention period in days (1-35)
      default: 7
      min: 1
      max: 35

    - name: preferred_backup_window
      type: string
      description: Daily backup window in UTC (e.g., 03:00-04:00)
      default: "03:00-04:00"

    - name: preferred_maintenance_window
      type: string
      description: Weekly maintenance window in UTC (e.g., sun:04:00-sun:05:00)
      default: "sun:04:00-sun:05:00"

    # Encryption
    - name: storage_encrypted
      type: boolean
      description: Enable storage encryption
      default: true

    - name: kms_key_id
      type: string
      description: KMS key ID for encryption (leave empty for AWS managed key)
      default: ""

    # Monitoring & Logging
    - name: enabled_cloudwatch_logs_exports
      type: string
      description: Comma-separated log types to export (postgresql or audit,error,general,slowquery for MySQL)
      default: "postgresql"

    - name: performance_insights_enabled
      type: boolean
      description: Enable Performance Insights for query monitoring
      default: true

    - name: performance_insights_retention_period
      type: number
      description: Performance Insights data retention in days (7 or 731)
      default: 7
      min: 7
      max: 731

    - name: monitoring_interval
      type: number
      description: Enhanced monitoring interval in seconds (0, 1, 5, 10, 15, 30, 60)
      default: 60
      min: 0
      max: 60

    # Deletion Protection
    - name: deletion_protection
      type: boolean
      description: Enable deletion protection
      default: true

    - name: skip_final_snapshot
      type: boolean
      description: Skip final snapshot when deleting (not recommended for production)
      default: false

    - name: final_snapshot_identifier
      type: string
      description: Name for final snapshot (if skip_final_snapshot is false)
      default: ""

    # Advanced Configuration
    - name: enable_http_endpoint
      type: boolean
      description: Enable Data API for serverless HTTP access
      default: false

    - name: auto_minor_version_upgrade
      type: boolean
      description: Enable automatic minor version upgrades
      default: true

    - name: apply_immediately
      type: boolean
      description: Apply changes immediately (vs during maintenance window)
      default: false

    # Parameter Group
    - name: custom_parameter_group_family
      type: string
      description: Parameter group family (e.g., aurora-postgresql15, aurora-mysql8.0)
      default: "aurora-postgresql15"

    # Tags
    - name: environment
      type: string
      description: Environment name (dev, staging, prod)
      default: ""

    - name: application
      type: string
      description: Application name
      default: ""
