output "cluster_id" {
  description = "RDS cluster identifier"
  value       = aws_rds_cluster.plugin_rds_serverless.id
}

output "cluster_arn" {
  description = "ARN of the RDS cluster"
  value       = aws_rds_cluster.plugin_rds_serverless.arn
}

output "cluster_endpoint" {
  description = "Writer endpoint for the cluster"
  value       = aws_rds_cluster.plugin_rds_serverless.endpoint
}

output "cluster_reader_endpoint" {
  description = "Reader endpoint for the cluster"
  value       = aws_rds_cluster.plugin_rds_serverless.reader_endpoint
}

output "cluster_port" {
  description = "Port the cluster accepts connections on"
  value       = aws_rds_cluster.plugin_rds_serverless.port
}

output "cluster_database_name" {
  description = "Name of the default database"
  value       = aws_rds_cluster.plugin_rds_serverless.database_name
}

output "cluster_master_username" {
  description = "Master username for the database"
  value       = aws_rds_cluster.plugin_rds_serverless.master_username
  sensitive   = true
}

output "cluster_master_password" {
  description = "Master password for the database"
  value       = random_password.plugin_rds_serverless_master_password.result
  sensitive   = true
}

output "cluster_resource_id" {
  description = "RDS cluster resource ID"
  value       = aws_rds_cluster.plugin_rds_serverless.cluster_resource_id
}

output "cluster_instances" {
  description = "List of RDS cluster instance identifiers"
  value       = aws_rds_cluster_instance.plugin_rds_serverless[*].id
}

output "secrets_manager_secret_arn" {
  description = "ARN of Secrets Manager secret containing database credentials"
  value       = aws_secretsmanager_secret.plugin_rds_serverless_credentials.arn
}

output "secrets_manager_secret_name" {
  description = "Name of Secrets Manager secret"
  value       = aws_secretsmanager_secret.plugin_rds_serverless_credentials.name
}

{{#if enable_http_endpoint}}
output "data_api_enabled" {
  description = "Whether Data API is enabled"
  value       = true
}
{{/if}}

# Connection information
output "connection_info" {
  description = "How to connect to this Aurora Serverless cluster"
  value = <<-EOT
    Aurora Serverless Cluster: ${var.project_name}
    Engine: ${var.engine} ${var.engine_version}
    Cluster ID: ${aws_rds_cluster.plugin_rds_serverless.id}

    # Writer Endpoint (Read/Write):
    ${aws_rds_cluster.plugin_rds_serverless.endpoint}:${aws_rds_cluster.plugin_rds_serverless.port}

    # Reader Endpoint (Read-Only):
    ${aws_rds_cluster.plugin_rds_serverless.reader_endpoint}:${aws_rds_cluster.plugin_rds_serverless.port}

    Database: ${aws_rds_cluster.plugin_rds_serverless.database_name}
    Username: ${aws_rds_cluster.plugin_rds_serverless.master_username}

    # Get password from Secrets Manager:
    aws secretsmanager get-secret-value \
      --secret-id ${aws_secretsmanager_secret.plugin_rds_serverless_credentials.name} \
      --query SecretString \
      --output text | jq -r .password

    {{#if (eq engine "aurora-postgresql")}}
    # Connect using psql:
    psql -h ${aws_rds_cluster.plugin_rds_serverless.endpoint} \
         -p ${aws_rds_cluster.plugin_rds_serverless.port} \
         -U ${aws_rds_cluster.plugin_rds_serverless.master_username} \
         -d ${aws_rds_cluster.plugin_rds_serverless.database_name}
    {{else}}
    # Connect using mysql:
    mysql -h ${aws_rds_cluster.plugin_rds_serverless.endpoint} \
          -P ${aws_rds_cluster.plugin_rds_serverless.port} \
          -u ${aws_rds_cluster.plugin_rds_serverless.master_username} \
          -p \
          ${aws_rds_cluster.plugin_rds_serverless.database_name}
    {{/if}}

    # Serverless Scaling:
    Min Capacity: ${var.serverless_min_capacity} ACUs
    Max Capacity: ${var.serverless_max_capacity} ACUs

    # High Availability:
    Instances: ${var.instance_count}
    Multi-AZ: ${var.instance_count > 1 ? "Yes" : "No"}

    # Backup:
    Retention: ${var.backup_retention_period} days
    Window: ${var.preferred_backup_window}

    {{#if enable_http_endpoint}}
    # Data API (Serverless HTTP access):
    Enabled - Use AWS SDK to execute SQL via HTTP
    {{/if}}

    {{#if performance_insights_enabled}}
    # Performance Insights:
    Enabled - View query performance in RDS console
    {{/if}}
  EOT
}

# SDK connection examples
output "connection_examples" {
  description = "Code examples for connecting to the database"
  value = <<-EOT
    {{#if (eq engine "aurora-postgresql")}}
    # Python (psycopg2):
    import psycopg2
    import boto3
    import json

    # Get credentials from Secrets Manager
    client = boto3.client('secretsmanager', region_name='${data.aws_region.current.name}')
    secret = json.loads(client.get_secret_value(SecretId='${aws_secretsmanager_secret.plugin_rds_serverless_credentials.name}')['SecretString'])

    conn = psycopg2.connect(
        host=secret['host'],
        port=secret['port'],
        database=secret['dbname'],
        user=secret['username'],
        password=secret['password']
    )

    # Node.js (pg):
    const { Client } = require('pg');
    const AWS = require('aws-sdk');

    const secretsManager = new AWS.SecretsManager({ region: '${data.aws_region.current.name}' });
    const secret = await secretsManager.getSecretValue({ SecretId: '${aws_secretsmanager_secret.plugin_rds_serverless_credentials.name}' }).promise();
    const credentials = JSON.parse(secret.SecretString);

    const client = new Client({
        host: credentials.host,
        port: credentials.port,
        database: credentials.dbname,
        user: credentials.username,
        password: credentials.password,
    });
    await client.connect();
    {{else}}
    # Python (PyMySQL):
    import pymysql
    import boto3
    import json

    # Get credentials from Secrets Manager
    client = boto3.client('secretsmanager', region_name='${data.aws_region.current.name}')
    secret = json.loads(client.get_secret_value(SecretId='${aws_secretsmanager_secret.plugin_rds_serverless_credentials.name}')['SecretString'])

    conn = pymysql.connect(
        host=secret['host'],
        port=secret['port'],
        database=secret['dbname'],
        user=secret['username'],
        password=secret['password']
    )

    # Node.js (mysql2):
    const mysql = require('mysql2/promise');
    const AWS = require('aws-sdk');

    const secretsManager = new AWS.SecretsManager({ region: '${data.aws_region.current.name}' });
    const secret = await secretsManager.getSecretValue({ SecretId: '${aws_secretsmanager_secret.plugin_rds_serverless_credentials.name}' }).promise();
    const credentials = JSON.parse(secret.SecretString);

    const connection = await mysql.createConnection({
        host: credentials.host,
        port: credentials.port,
        database: credentials.dbname,
        user: credentials.username,
        password: credentials.password,
    });
    {{/if}}

    {{#if enable_http_endpoint}}
    # Using Data API (Python):
    import boto3

    rds_data = boto3.client('rds-data', region_name='${data.aws_region.current.name}')

    response = rds_data.execute_statement(
        resourceArn='${aws_rds_cluster.plugin_rds_serverless.arn}',
        secretArn='${aws_secretsmanager_secret.plugin_rds_serverless_credentials.arn}',
        database='${aws_rds_cluster.plugin_rds_serverless.database_name}',
        sql='SELECT version()'
    )
    {{/if}}
  EOT
}

# Monitoring information
output "monitoring_info" {
  description = "Monitoring and observability information"
  value = <<-EOT
    CloudWatch Metrics:
    Namespace: AWS/RDS

    Key Metrics:
    - DatabaseConnections: Number of database connections
    - CPUUtilization: CPU usage percentage
    - FreeableMemory: Available memory
    - ServerlessDatabaseCapacity: Current ACU capacity
    - ACUUtilization: Percentage of allocated ACUs used
    - ReadLatency / WriteLatency: I/O latency

    # View current capacity:
    aws cloudwatch get-metric-statistics \
      --namespace AWS/RDS \
      --metric-name ServerlessDatabaseCapacity \
      --dimensions Name=DBClusterIdentifier,Value=${aws_rds_cluster.plugin_rds_serverless.id} \
      --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \
      --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
      --period 300 \
      --statistics Average

    {{#if performance_insights_enabled}}
    # Performance Insights:
    https://console.aws.amazon.com/rds/home?region=${data.aws_region.current.name}#performance-insights-v20206:/resourceId/${aws_rds_cluster.plugin_rds_serverless.cluster_resource_id}
    {{/if}}

    # RDS Console:
    https://console.aws.amazon.com/rds/home?region=${data.aws_region.current.name}#database:id=${aws_rds_cluster.plugin_rds_serverless.id}
  EOT
}
