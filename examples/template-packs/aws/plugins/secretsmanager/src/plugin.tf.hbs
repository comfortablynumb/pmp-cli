terraform {
  required_version = ">= 1.0"

  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
    random = {
      source  = "hashicorp/random"
      version = "~> 3.0"
    }
  }
}

data "aws_region" "current" {}

locals {
  secret_name = var.project_name
  replica_regions_list = var.replica_regions != "" ? split(",", var.replica_regions) : []

  # Build tags
  common_tags = merge(
    {
      Name      = var.project_name
      ManagedBy = "pmp"
      Plugin    = "aws/secretsmanager"
    },
    var.application != "" ? { Application = var.application } : {},
    var.environment != "" ? { Environment = var.environment } : {}
  )
}

{{#if (eq secret_type "random")}}
# Auto-generate random password
resource "random_password" "plugin_secretsmanager_random" {
  length  = var.password_length
  special = true
  override_special = var.exclude_characters != "" ? "" : "!@#$%^&*()_+-=[]{}|;:,.<>?"
  numeric = var.require_each_included_type
  upper   = var.require_each_included_type
  lower   = var.require_each_included_type
}
{{/if}}

{{#if create_database_secret}}
# Generate random database password
resource "random_password" "plugin_secretsmanager_db_password" {
  length  = 32
  special = true
  override_special = "!@#$%^&*()_+-="
}

# Database connection secret
resource "aws_secretsmanager_secret" "plugin_secretsmanager" {
  name        = local.secret_name
  description = var.secret_description != "" ? var.secret_description : "Database credentials for ${var.project_name}"

  {{#if kms_key_id}}
  kms_key_id = var.kms_key_id
  {{/if}}

  recovery_window_in_days = var.recovery_window_days

  {{#if enable_replication}}
  {{#each replica_regions_list}}
  replica {
    region = "{{this}}"
    {{#if ../kms_key_id}}
    kms_key_id = var.kms_key_id
    {{/if}}
  }
  {{/each}}
  {{/if}}

  tags = local.common_tags
}

resource "aws_secretsmanager_secret_version" "plugin_secretsmanager" {
  secret_id = aws_secretsmanager_secret.plugin_secretsmanager.id

  secret_string = jsonencode({
    engine   = var.db_engine
    host     = var.db_host
    port     = var.db_port
    dbname   = var.db_name
    username = var.db_username
    password = random_password.plugin_secretsmanager_db_password.result
  })
}

{{#if enable_rotation}}
resource "aws_secretsmanager_secret_rotation" "plugin_secretsmanager" {
  secret_id           = aws_secretsmanager_secret.plugin_secretsmanager.id
  rotation_lambda_arn = var.rotation_lambda_arn

  rotation_rules {
    automatically_after_days = var.rotation_days
  }
}
{{/if}}

{{else if create_api_key_secret}}
# Generate random API key
resource "random_password" "plugin_secretsmanager_api_key" {
  length  = 40
  special = false
}

# API Key secret
resource "aws_secretsmanager_secret" "plugin_secretsmanager" {
  name        = local.secret_name
  description = var.secret_description != "" ? var.secret_description : "API key for ${var.api_key_name}"

  {{#if kms_key_id}}
  kms_key_id = var.kms_key_id
  {{/if}}

  recovery_window_in_days = var.recovery_window_days

  {{#if enable_replication}}
  {{#each replica_regions_list}}
  replica {
    region = "{{this}}"
    {{#if ../kms_key_id}}
    kms_key_id = var.kms_key_id
    {{/if}}
  }
  {{/each}}
  {{/if}}

  tags = local.common_tags
}

resource "aws_secretsmanager_secret_version" "plugin_secretsmanager" {
  secret_id = aws_secretsmanager_secret.plugin_secretsmanager.id

  secret_string = jsonencode({
    api_key     = random_password.plugin_secretsmanager_api_key.result
    service     = var.api_key_name
    created_at  = timestamp()
  })
}

{{else if (eq secret_type "random")}}
# Random password secret
resource "aws_secretsmanager_secret" "plugin_secretsmanager" {
  name        = local.secret_name
  description = var.secret_description != "" ? var.secret_description : "Auto-generated password for ${var.project_name}"

  {{#if kms_key_id}}
  kms_key_id = var.kms_key_id
  {{/if}}

  recovery_window_in_days = var.recovery_window_days

  {{#if enable_replication}}
  {{#each replica_regions_list}}
  replica {
    region = "{{this}}"
    {{#if ../kms_key_id}}
    kms_key_id = var.kms_key_id
    {{/if}}
  }
  {{/each}}
  {{/if}}

  tags = local.common_tags
}

resource "aws_secretsmanager_secret_version" "plugin_secretsmanager" {
  secret_id     = aws_secretsmanager_secret.plugin_secretsmanager.id
  secret_string = random_password.plugin_secretsmanager_random.result
}

{{else}}
# Generic secret (JSON or plaintext)
resource "aws_secretsmanager_secret" "plugin_secretsmanager" {
  name        = local.secret_name
  description = var.secret_description != "" ? var.secret_description : "Secret for ${var.project_name}"

  {{#if kms_key_id}}
  kms_key_id = var.kms_key_id
  {{/if}}

  recovery_window_in_days = var.recovery_window_days

  {{#if enable_replication}}
  {{#each replica_regions_list}}
  replica {
    region = "{{this}}"
    {{#if ../kms_key_id}}
    kms_key_id = var.kms_key_id
    {{/if}}
  }
  {{/each}}
  {{/if}}

  tags = local.common_tags
}

# Note: Secret value must be set manually after creation or via separate terraform apply
# This prevents storing sensitive values in state during initial creation
{{/if}}

# IAM policy for secret access
data "aws_iam_policy_document" "plugin_secretsmanager_access" {
  statement {
    sid    = "AllowSecretAccess"
    effect = "Allow"

    actions = [
      "secretsmanager:GetSecretValue",
      "secretsmanager:DescribeSecret"
    ]

    resources = [
      aws_secretsmanager_secret.plugin_secretsmanager.arn
    ]
  }

  {{#if kms_key_id}}
  statement {
    sid    = "AllowKMSDecrypt"
    effect = "Allow"

    actions = [
      "kms:Decrypt",
      "kms:DescribeKey"
    ]

    resources = [
      var.kms_key_id
    ]
  }
  {{/if}}
}

resource "aws_iam_policy" "plugin_secretsmanager_access" {
  name        = "${local.secret_name}-access-policy"
  description = "Policy to access ${local.secret_name} secret"
  policy      = data.aws_iam_policy_document.plugin_secretsmanager_access.json

  tags = local.common_tags
}
