output "secret_id" {
  description = "Secrets Manager secret ID"
  value       = aws_secretsmanager_secret.plugin_secretsmanager.id
}

output "secret_arn" {
  description = "ARN of the secret"
  value       = aws_secretsmanager_secret.plugin_secretsmanager.arn
}

output "secret_name" {
  description = "Name of the secret"
  value       = aws_secretsmanager_secret.plugin_secretsmanager.name
}

{{#if (or (eq secret_type "random") create_database_secret create_api_key_secret)}}
output "secret_value" {
  description = "The secret value (sensitive)"
  value       = aws_secretsmanager_secret_version.plugin_secretsmanager.secret_string
  sensitive   = true
}
{{/if}}

output "secret_version_id" {
  description = "Version ID of the secret"
  value       = try(aws_secretsmanager_secret_version.plugin_secretsmanager.version_id, "")
}

output "access_policy_arn" {
  description = "ARN of IAM policy for accessing this secret"
  value       = aws_iam_policy.plugin_secretsmanager_access.arn
}

output "access_policy_name" {
  description = "Name of IAM policy for accessing this secret"
  value       = aws_iam_policy.plugin_secretsmanager_access.name
}

{{#if enable_replication}}
output "replica_regions" {
  description = "Regions where secret is replicated"
  value       = local.replica_regions_list
}
{{/if}}

{{#if enable_rotation}}
output "rotation_enabled" {
  description = "Whether rotation is enabled"
  value       = true
}

output "rotation_days" {
  description = "Number of days between rotations"
  value       = var.rotation_days
}
{{/if}}

# Connection information
output "connection_info" {
  description = "How to use this secret"
  value = <<-EOT
    Secret Name: ${aws_secretsmanager_secret.plugin_secretsmanager.name}
    ARN: ${aws_secretsmanager_secret.plugin_secretsmanager.arn}
    Region: ${data.aws_region.current.name}

    # AWS CLI - Get secret value:
    aws secretsmanager get-secret-value --secret-id ${aws_secretsmanager_secret.plugin_secretsmanager.name} --region ${data.aws_region.current.name}

    # AWS CLI - Get secret as JSON:
    aws secretsmanager get-secret-value --secret-id ${aws_secretsmanager_secret.plugin_secretsmanager.name} --query SecretString --output text | jq .

    {{#if create_database_secret}}
    # Database Connection Details:
    Engine: ${var.db_engine}
    Host: ${var.db_host}
    Port: ${var.db_port}
    Database: ${var.db_name}
    Username: ${var.db_username}
    # Password is stored in the secret

    # Get database password:
    aws secretsmanager get-secret-value --secret-id ${aws_secretsmanager_secret.plugin_secretsmanager.name} --query SecretString --output text | jq -r .password
    {{/if}}

    {{#if enable_rotation}}
    # Rotation Configuration:
    Rotation Enabled: Yes
    Rotation Interval: ${var.rotation_days} days
    Lambda ARN: ${var.rotation_lambda_arn}
    {{/if}}

    {{#if enable_replication}}
    # Replication:
    Replicated to: ${join(", ", local.replica_regions_list)}
    {{/if}}

    # IAM Policy for Access:
    Attach this policy ARN to roles/users that need access:
    ${aws_iam_policy.plugin_secretsmanager_access.arn}
  EOT
}

# SDK examples
output "usage_examples" {
  description = "Code examples for accessing this secret"
  value = <<-EOT
    # Python (boto3):
    import boto3
    import json
    client = boto3.client('secretsmanager', region_name='${data.aws_region.current.name}')
    response = client.get_secret_value(SecretId='${aws_secretsmanager_secret.plugin_secretsmanager.name}')
    secret = json.loads(response['SecretString'])

    {{#if create_database_secret}}
    # Connect to database using secret:
    import psycopg2
    conn = psycopg2.connect(
        host=secret['host'],
        port=secret['port'],
        database=secret['dbname'],
        user=secret['username'],
        password=secret['password']
    )
    {{/if}}

    # Node.js (AWS SDK v3):
    import { SecretsManagerClient, GetSecretValueCommand } from "@aws-sdk/client-secrets-manager";
    const client = new SecretsManagerClient({ region: "${data.aws_region.current.name}" });
    const response = await client.send(new GetSecretValueCommand({
      SecretId: "${aws_secretsmanager_secret.plugin_secretsmanager.name}"
    }));
    const secret = JSON.parse(response.SecretString);

    # Go:
    import (
        "github.com/aws/aws-sdk-go/aws"
        "github.com/aws/aws-sdk-go/aws/session"
        "github.com/aws/aws-sdk-go/service/secretsmanager"
    )
    sess := session.Must(session.NewSession())
    svc := secretsmanager.New(sess, aws.NewConfig().WithRegion("${data.aws_region.current.name}"))
    result, _ := svc.GetSecretValue(&secretsmanager.GetSecretValueInput{
        SecretId: aws.String("${aws_secretsmanager_secret.plugin_secretsmanager.name}"),
    })

    # Java:
    SecretsManagerClient client = SecretsManagerClient.builder()
        .region(Region.of("${data.aws_region.current.name}"))
        .build();
    GetSecretValueRequest request = GetSecretValueRequest.builder()
        .secretId("${aws_secretsmanager_secret.plugin_secretsmanager.name}")
        .build();
    GetSecretValueResponse response = client.getSecretValue(request);
  EOT
}
