output "web_acl_id" {
  description = "WAF Web ACL ID"
  value       = aws_wafv2_web_acl.plugin_waf.id
}

output "web_acl_arn" {
  description = "ARN of the Web ACL"
  value       = aws_wafv2_web_acl.plugin_waf.arn
}

output "web_acl_name" {
  description = "Name of the Web ACL"
  value       = aws_wafv2_web_acl.plugin_waf.name
}

output "web_acl_capacity" {
  description = "Web ACL capacity units used"
  value       = aws_wafv2_web_acl.plugin_waf.capacity
}

{{#if enable_ip_allowlist}}
output "ip_allowlist_arn" {
  description = "ARN of IP allowlist IP set"
  value       = aws_wafv2_ip_set.plugin_waf_allowlist.arn
}
{{/if}}

{{#if enable_ip_blocklist}}
output "ip_blocklist_arn" {
  description = "ARN of IP blocklist IP set"
  value       = aws_wafv2_ip_set.plugin_waf_blocklist.arn
}
{{/if}}

{{#if enable_logging}}
{{#if (eq log_destination_type "cloudwatch")}}
output "log_group_name" {
  description = "CloudWatch Log Group name for WAF logs"
  value       = aws_cloudwatch_log_group.plugin_waf.name
}

output "log_group_arn" {
  description = "CloudWatch Log Group ARN"
  value       = aws_cloudwatch_log_group.plugin_waf.arn
}
{{/if}}
{{/if}}

# Connection information
output "connection_info" {
  description = "How to use this WAF Web ACL"
  value = <<-EOT
    WAF Web ACL: ${aws_wafv2_web_acl.plugin_waf.name}
    ARN: ${aws_wafv2_web_acl.plugin_waf.arn}
    Scope: ${var.scope}
    Region: ${data.aws_region.current.name}

    # Associate with resources:

    {{#if (eq scope "CLOUDFRONT")}}
    # CloudFront Distribution:
    resource "aws_cloudfront_distribution" "example" {
      ...
      web_acl_id = "${aws_wafv2_web_acl.plugin_waf.arn}"
    }
    {{else}}
    # Application Load Balancer:
    resource "aws_wafv2_web_acl_association" "alb" {
      resource_arn = aws_lb.example.arn
      web_acl_arn  = "${aws_wafv2_web_acl.plugin_waf.arn}"
    }

    # API Gateway Stage:
    resource "aws_wafv2_web_acl_association" "apigw" {
      resource_arn = aws_apigatewayv2_stage.example.arn
      web_acl_arn  = "${aws_wafv2_web_acl.plugin_waf.arn}"
    }

    # AppSync GraphQL API:
    resource "aws_wafv2_web_acl_association" "appsync" {
      resource_arn = aws_appsync_graphql_api.example.arn
      web_acl_arn  = "${aws_wafv2_web_acl.plugin_waf.arn}"
    }
    {{/if}}

    # AWS CLI - Associate with ALB:
    aws wafv2 associate-web-acl \
      --web-acl-arn ${aws_wafv2_web_acl.plugin_waf.arn} \
      --resource-arn <ALB_ARN> \
      --region ${data.aws_region.current.name}

    {{#if enable_logging}}
    # View WAF logs:
    aws logs tail /aws/wafv2/${local.web_acl_name} --follow --region ${data.aws_region.current.name}
    {{/if}}

    # Get sampled requests:
    aws wafv2 get-sampled-requests \
      --web-acl-arn ${aws_wafv2_web_acl.plugin_waf.arn} \
      --rule-metric-name ${local.web_acl_name} \
      --scope ${var.scope} \
      --time-window StartTime=$(date -u -d '1 hour ago' +%s),EndTime=$(date -u +%s) \
      --max-items 100

    # Protection Features Enabled:
    {{#if enable_core_rule_set}}- OWASP Top 10 Protection: Yes{{/if}}
    {{#if enable_sqli_protection}}- SQL Injection Protection: Yes{{/if}}
    {{#if enable_rate_limiting}}- Rate Limiting: ${var.rate_limit} requests per 5 minutes{{/if}}
    {{#if enable_geo_blocking}}- Geo Blocking: ${join(", ", local.blocked_countries_list)}{{/if}}
    {{#if enable_amazon_ip_reputation}}- Amazon IP Reputation: Yes{{/if}}
    {{#if enable_anonymous_ip_list}}- Anonymous IP Blocking: Yes{{/if}}
    {{#if enable_ip_allowlist}}- IP Allowlist: ${length(local.allowed_ips_list)} IPs{{/if}}
    {{#if enable_ip_blocklist}}- IP Blocklist: ${length(local.blocked_ips_list)} IPs{{/if}}
  EOT
}

# Monitoring and metrics
output "monitoring_info" {
  description = "CloudWatch metrics and monitoring information"
  value = <<-EOT
    CloudWatch Metrics:
    Namespace: AWS/WAFV2

    Key Metrics:
    - AllowedRequests: aws cloudwatch get-metric-statistics --namespace AWS/WAFV2 --metric-name AllowedRequests --dimensions Name=WebACL,Value=${aws_wafv2_web_acl.plugin_waf.name} Name=Region,Value=${data.aws_region.current.name} Name=Rule,Value=ALL --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) --end-time $(date -u +%Y-%m-%dT%H:%M:%S) --period 300 --statistics Sum

    - BlockedRequests: aws cloudwatch get-metric-statistics --namespace AWS/WAFV2 --metric-name BlockedRequests --dimensions Name=WebACL,Value=${aws_wafv2_web_acl.plugin_waf.name} Name=Region,Value=${data.aws_region.current.name} Name=Rule,Value=ALL --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) --end-time $(date -u +%Y-%m-%dT%H:%M:%S) --period 300 --statistics Sum

    - CountedRequests: aws cloudwatch get-metric-statistics --namespace AWS/WAFV2 --metric-name CountedRequests --dimensions Name=WebACL,Value=${aws_wafv2_web_acl.plugin_waf.name} Name=Region,Value=${data.aws_region.current.name} Name=Rule,Value=ALL --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) --end-time $(date -u +%Y-%m-%dT%H:%M:%S) --period 300 --statistics Sum

    Dashboard: https://console.aws.amazon.com/wafv2/homev2/web-acl/${aws_wafv2_web_acl.plugin_waf.name}/overview?region=${data.aws_region.current.name}
  EOT
}
