# Basic Settings
variable "repository_name" {
  type        = string
  description = "ECR repository name (must be unique within AWS account and region)"
  default     = "{{repository_name}}"

  validation {
    condition     = can(regex("^[a-z0-9](?:[a-z0-9._-]*[a-z0-9])?(?:/[a-z0-9](?:[a-z0-9._-]*[a-z0-9])?)*$", var.repository_name))
    error_message = "Repository name must be lowercase, alphanumeric, and can contain hyphens, underscores, periods, and forward slashes."
  }

  validation {
    condition     = length(var.repository_name) <= 256
    error_message = "Repository name must be 256 characters or less."
  }
}

variable "image_tag_mutability" {
  type        = string
  description = "Tag mutability setting for the repository"
  default     = "{{image_tag_mutability}}"

  validation {
    condition     = contains(["MUTABLE", "IMMUTABLE"], var.image_tag_mutability)
    error_message = "Image tag mutability must be either MUTABLE or IMMUTABLE."
  }
}

variable "force_delete" {
  type        = bool
  description = "Allow repository deletion even if it contains images"
  default     = {{bool force_delete}}
}

# Encryption Settings
variable "encryption_type" {
  type        = string
  description = "Encryption type for images at rest"
  default     = "{{encryption_type}}"

  validation {
    condition     = contains(["AES256", "KMS"], var.encryption_type)
    error_message = "Encryption type must be either AES256 or KMS."
  }
}

variable "kms_key_arn" {
  type        = string
  description = "ARN of KMS key for encryption (only used when encryption_type is KMS)"
  default     = "{{kms_key_arn}}"

  validation {
    condition     = var.kms_key_arn == "" || can(regex("^arn:aws:kms:[a-z0-9-]+:[0-9]{12}:key/[a-f0-9-]+$", var.kms_key_arn))
    error_message = "KMS key ARN must be a valid ARN format or empty."
  }
}

variable "enable_kms_key_rotation" {
  type        = bool
  description = "Enable automatic key rotation for KMS keys (only when no custom KMS key is provided)"
  default     = {{bool enable_kms_key_rotation}}
}

# Image Scanning
variable "scan_on_push" {
  type        = bool
  description = "Enable automatic image scanning when images are pushed"
  default     = {{bool scan_on_push}}
}

# Lifecycle Policy Settings
variable "enable_lifecycle_policy" {
  type        = bool
  description = "Enable lifecycle policy to automatically clean up old images"
  default     = {{bool enable_lifecycle_policy}}
}

variable "keep_image_count" {
  type        = number
  description = "Number of tagged images to retain (for lifecycle policy)"
  default     = {{keep_image_count}}

  validation {
    condition     = var.keep_image_count > 0 && var.keep_image_count <= 1000
    error_message = "Keep image count must be between 1 and 1000."
  }
}

variable "lifecycle_tag_prefix" {
  type        = string
  description = "Tag prefix for lifecycle policy rules"
  default     = "{{lifecycle_tag_prefix}}"
}

variable "lifecycle_tag_status" {
  type        = string
  description = "Apply lifecycle rules to which tag types"
  default     = "{{lifecycle_tag_status}}"

  validation {
    condition     = contains(["tagged", "untagged", "any"], var.lifecycle_tag_status)
    error_message = "Lifecycle tag status must be tagged, untagged, or any."
  }
}

variable "expire_untagged_after_days" {
  type        = number
  description = "Number of days to keep untagged images before expiring them"
  default     = {{expire_untagged_after_days}}

  validation {
    condition     = var.expire_untagged_after_days > 0 && var.expire_untagged_after_days <= 365
    error_message = "Expire untagged after days must be between 1 and 365."
  }
}

# Repository Policy Settings
variable "enable_repository_policy" {
  type        = bool
  description = "Enable repository policy for cross-account or IAM-based access"
  default     = {{bool enable_repository_policy}}
}

variable "allowed_aws_account_ids" {
  type        = string
  description = "Comma-separated list of AWS account IDs allowed to pull images"
  default     = "{{allowed_aws_account_ids}}"
}

variable "allowed_iam_arns" {
  type        = string
  description = "Comma-separated list of IAM ARNs allowed to access repository"
  default     = "{{allowed_iam_arns}}"
}

# Tagging
variable "repository_tags" {
  type        = string
  description = "Repository tags as comma-separated key:value pairs"
  default     = "{{repository_tags}}"
}
