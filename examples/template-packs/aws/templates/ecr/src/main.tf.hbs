terraform {
  required_version = ">= 1.0"

  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

# AWS provider configuration
# Authentication via AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, and AWS_DEFAULT_REGION environment variables
# Or via AWS CLI configuration (~/.aws/credentials)
# Or via IAM role when running on AWS infrastructure
provider "aws" {
  # region = var.aws_region  # Optional: Use environment variable AWS_DEFAULT_REGION instead
}

{{#if (and (eq encryption_type "KMS") (eq kms_key_arn ""))}}
# KMS key for ECR encryption (only created if encryption_type is KMS and no custom key provided)
resource "aws_kms_key" "ecr" {
  description             = "KMS key for ECR repository: {{repository_name}}"
  deletion_window_in_days = 10
  enable_key_rotation     = var.enable_kms_key_rotation

  tags = merge(
    local.tags,
    {
      Name = "ecr-{{repository_name}}"
    }
  )
}

resource "aws_kms_alias" "ecr" {
  name          = "alias/ecr-{{repository_name}}"
  target_key_id = aws_kms_key.ecr.key_id
}
{{/if}}

# ECR Repository
resource "aws_ecr_repository" "repo" {
  name                 = var.repository_name
  image_tag_mutability = var.image_tag_mutability
  force_delete         = var.force_delete

  # Encryption configuration
  encryption_configuration {
    encryption_type = var.encryption_type
    {{#if (eq encryption_type "KMS")}}
    {{#if kms_key_arn}}
    kms_key = var.kms_key_arn
    {{else}}
    kms_key = aws_kms_key.ecr.arn
    {{/if}}
    {{/if}}
  }

  # Image scanning configuration
  image_scanning_configuration {
    scan_on_push = var.scan_on_push
  }

  tags = merge(
    local.tags,
    {
      Name = var.repository_name
    }
  )

  lifecycle {
    prevent_destroy = false
  }
}

# Local variables for tagging
locals {
  tags = merge(
    {
      ManagedBy = "pmp"
      Template  = "aws/ecr"
    },
    {{#if repository_tags}}
    {
      for entry in split(",", var.repository_tags) :
      split(":", trimspace(entry))[0] => split(":", trimspace(entry))[1]
      if trimspace(entry) != "" && length(split(":", trimspace(entry))) == 2
    }
    {{else}}
    {}
    {{/if}}
  )
}
