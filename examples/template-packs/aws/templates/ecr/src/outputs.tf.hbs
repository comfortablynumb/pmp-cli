# Repository Information
output "repository_name" {
  description = "The name of the ECR repository"
  value       = aws_ecr_repository.repo.name
}

output "repository_arn" {
  description = "The ARN of the ECR repository"
  value       = aws_ecr_repository.repo.arn
}

output "repository_url" {
  description = "The URL of the ECR repository"
  value       = aws_ecr_repository.repo.repository_url
}

output "registry_id" {
  description = "The registry ID where the repository was created"
  value       = aws_ecr_repository.repo.registry_id
}

# Configuration Details
output "image_tag_mutability" {
  description = "The tag mutability setting for the repository"
  value       = aws_ecr_repository.repo.image_tag_mutability
}

output "encryption_type" {
  description = "The encryption type used for the repository"
  value       = var.encryption_type
}

{{#if (and (eq encryption_type "KMS") (eq kms_key_arn ""))}}
output "kms_key_id" {
  description = "The ID of the KMS key used for encryption"
  value       = aws_kms_key.ecr.id
}

output "kms_key_arn" {
  description = "The ARN of the KMS key used for encryption"
  value       = aws_kms_key.ecr.arn
}
{{/if}}

# Docker Commands
output "docker_login_command" {
  description = "AWS CLI command to authenticate Docker to ECR"
  value       = <<-EOT
    # Login to ECR (using AWS CLI v2)
    aws ecr get-login-password --region ${data.aws_region.current.name} | \
      docker login --username AWS --password-stdin ${aws_ecr_repository.repo.repository_url}

    # Alternative: Login using legacy command (AWS CLI v1)
    $(aws ecr get-login --region ${data.aws_region.current.name} --no-include-email)
  EOT
}

output "docker_commands" {
  description = "Common Docker commands for this ECR repository"
  value = <<-EOT
    # Tag your local image
    docker tag <local-image>:latest ${aws_ecr_repository.repo.repository_url}:latest

    # Push image to ECR
    docker push ${aws_ecr_repository.repo.repository_url}:latest

    # Push with version tag
    docker tag <local-image>:latest ${aws_ecr_repository.repo.repository_url}:v1.0.0
    docker push ${aws_ecr_repository.repo.repository_url}:v1.0.0

    # Pull image from ECR
    docker pull ${aws_ecr_repository.repo.repository_url}:latest

    # List tags
    docker images ${aws_ecr_repository.repo.repository_url}
  EOT
}

# AWS CLI Commands
output "aws_cli_commands" {
  description = "Useful AWS CLI commands for managing this repository"
  value = <<-EOT
    # List images in repository
    aws ecr list-images --repository-name ${aws_ecr_repository.repo.name}

    # Describe repository
    aws ecr describe-repositories --repository-names ${aws_ecr_repository.repo.name}

    # Describe images
    aws ecr describe-images --repository-name ${aws_ecr_repository.repo.name}

    # Get image scan findings
    aws ecr describe-image-scan-findings \
      --repository-name ${aws_ecr_repository.repo.name} \
      --image-id imageTag=latest

    # Start image scan
    aws ecr start-image-scan \
      --repository-name ${aws_ecr_repository.repo.name} \
      --image-id imageTag=latest

    {{#if (eq enable_lifecycle_policy "true")}}
    # Get lifecycle policy
    aws ecr get-lifecycle-policy --repository-name ${aws_ecr_repository.repo.name}

    # Preview lifecycle policy results
    aws ecr get-lifecycle-policy-preview --repository-name ${aws_ecr_repository.repo.name}
    {{/if}}

    {{#if (eq enable_repository_policy "true")}}
    # Get repository policy
    aws ecr get-repository-policy --repository-name ${aws_ecr_repository.repo.name}
    {{/if}}

    # Delete specific image
    aws ecr batch-delete-image \
      --repository-name ${aws_ecr_repository.repo.name} \
      --image-ids imageTag=<tag-to-delete>

    # Delete repository (use with caution!)
    aws ecr delete-repository \
      --repository-name ${aws_ecr_repository.repo.name} \
      {{#if (eq force_delete "true")}}
      --force
      {{/if}}
  EOT
}

# Repository Settings Summary
output "repository_settings" {
  description = "Current repository settings"
  value = {
    name                 = aws_ecr_repository.repo.name
    image_tag_mutability = aws_ecr_repository.repo.image_tag_mutability
    encryption_type      = var.encryption_type
    scan_on_push         = var.scan_on_push
    lifecycle_policy     = var.enable_lifecycle_policy
    repository_policy    = var.enable_repository_policy
    force_delete         = var.force_delete
  }
}

{{#if (eq enable_lifecycle_policy "true")}}
output "lifecycle_policy_enabled" {
  description = "Lifecycle policy configuration"
  value = {
    enabled                     = true
    keep_image_count            = var.keep_image_count
    lifecycle_tag_prefix        = var.lifecycle_tag_prefix
    lifecycle_tag_status        = var.lifecycle_tag_status
    expire_untagged_after_days  = var.expire_untagged_after_days
  }
}
{{/if}}

{{#if (eq enable_repository_policy "true")}}
output "repository_policy_enabled" {
  description = "Repository policy is configured"
  value       = "Cross-account or IAM-based access has been configured"
}
{{/if}}

# Data source to get current region
data "aws_region" "current" {}

# Data source to get current AWS account
data "aws_caller_identity" "current" {}

output "aws_account_id" {
  description = "AWS Account ID where the repository was created"
  value       = data.aws_caller_identity.current.account_id
}

output "aws_region" {
  description = "AWS Region where the repository was created"
  value       = data.aws_region.current.name
}
