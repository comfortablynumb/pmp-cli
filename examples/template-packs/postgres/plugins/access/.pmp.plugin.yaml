apiVersion: pmp.io/v1
kind: Plugin
metadata:
  name: access
  description: Create database user credentials with configurable privileges

spec:
  role: credential-management

  # This plugin requires a reference to a PostgreSQL project
  requires_project_with_template:
    apiVersion: pmp.io/v1
    kind: Postgres

    # Remote state configuration - maps reference project outputs to plugin module parameters
    remote_state:
      required_fields:
        postgres_host: {}  # No alias - parameter name same as output name
        postgres_port: {}
        postgres_database_name:
          alias: postgres_database  # Module parameter will be named 'postgres_database'
        postgres_username: {}
        postgres_password: {}
        postgres_sslmode: {}
        postgres_service_name: {}
        postgres_namespace: {}

  inputs:
    role_name:
      type: string
      description: Database role/user name to create
      # No default - required input

    role_password:
      type: string
      description: Password for the role (auto-generated if not provided)
      default: ""

    database_name:
      type: string
      description: Database to grant access to
      default: ""  # Inherited from parent template

    privileges:
      description: Array of privileges to grant (SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES, TRIGGER)
      default: ["SELECT"]

    grant_option:
      type: boolean
      description: Allow user to grant privileges to others
      default: false

    connection_limit:
      type: number
      min: -1
      description: Maximum concurrent connections (-1 for unlimited)
      default: -1

    valid_until:
      type: string
      description: Password expiration timestamp (format YYYY-MM-DD HH:MM:SS)
      default: ""

    schema_name:
      type: string
      description: Schema to grant privileges on
      default: "public"

    create_schema:
      type: boolean
      description: Allow user to create schemas
      default: false

    superuser:
      type: boolean
      description: Grant superuser privileges (WARNING - use with caution)
      default: false

    create_role:
      type: boolean
      description: Allow user to create other roles
      default: false

    create_db:
      type: boolean
      description: Allow user to create databases
      default: false