output "role_name" {
  description = "Name of the created PostgreSQL role"
  value       = postgresql_role.user.name
}

output "database_name" {
  description = "Database the role has access to"
  value       = local.actual_database
}

output "schema_name" {
  description = "Schema the role has privileges on"
  value       = var.schema_name
}

output "granted_privileges" {
  description = "Privileges granted to the role"
  value       = local.privileges_list
}

output "connection_limit" {
  description = "Maximum concurrent connections for this role"
  value       = postgresql_role.user.connection_limit
}

output "role_attributes" {
  description = "Role attributes summary"
  value = {
    superuser        = postgresql_role.user.superuser
    create_database  = postgresql_role.user.create_database
    create_role      = postgresql_role.user.create_role
    login            = postgresql_role.user.login
    connection_limit = postgresql_role.user.connection_limit
    valid_until      = postgresql_role.user.valid_until
  }
}

output "postgres_password" {
  description = "PostgreSQL password from reference project"
  value       = var.postgres_password
  sensitive   = true
}

output "postgres_sslmode" {
  description = "PostgreSQL SSL mode from reference project"
  value       = var.postgres_sslmode
}

output "connection_string" {
  description = "PostgreSQL connection string (password not included)"
  value       = "postgresql://${postgresql_role.user.name}@${var.postgres_host}:${var.postgres_port}/${local.actual_database}"
  sensitive   = false
}

output "jdbc_url" {
  description = "JDBC connection URL"
  value       = "jdbc:postgresql://${var.postgres_host}:${var.postgres_port}/${local.actual_database}"
  sensitive   = false
}

output "connection_params" {
  description = "Connection parameters for applications"
  value = {
    host     = var.postgres_host
    port     = var.postgres_port
    database = local.actual_database
    username = postgresql_role.user.name
    schema   = var.schema_name
  }
  sensitive = false
}

output "usage_notes" {
  description = "Important usage information"
  value = <<-EOT
    DATABASE CREDENTIALS CREATED
    ============================

    Role: ${postgresql_role.user.name}
    Database: ${local.actual_database}
    Schema: ${var.schema_name}
    Privileges: ${join(", ", local.privileges_list)}

    CONNECTION INFORMATION:
    - Host: ${var.postgres_host}
    - Port: ${var.postgres_port}
    - Database: ${local.actual_database}
    - Username: ${postgresql_role.user.name}
    {{#if create_k8s_secret}}- Password: Stored in K8s secret '${kubernetes_secret.db_credentials.metadata[0].name}'{{else}}- Password: Check your configuration or Terraform state{{/if}}

    SECURITY NOTES:
    - This role has ${length(local.privileges_list)} privilege(s) on schema '${var.schema_name}'
    - Connection limit: ${postgresql_role.user.connection_limit == -1 ? "unlimited" : postgresql_role.user.connection_limit}
    - Password expiration: ${var.valid_until != "" ? var.valid_until : "none"}

    CONNECT TO DATABASE:
    # Using psql with port-forward:
    kubectl port-forward -n ${var.postgres_namespace} svc/${var.postgres_service_name}-postgresql ${var.postgres_port}:${var.postgres_port}

    # From within Kubernetes:
    kubectl run -n ${var.postgres_namespace} pg-client --rm -it --restart=Never --image=postgres:16
  EOT
}

output "privilege_summary" {
  description = "Summary of granted privileges"
  value = <<-EOT
    Granted Privileges on ${var.schema_name} schema:
    - Tables: ${join(", ", local.privileges_list)}
    ${contains(local.privileges_list, "INSERT") || contains(local.privileges_list, "UPDATE") || contains(local.privileges_list, "ALL") ? "- Sequences: SELECT, UPDATE, USAGE" : ""}
    ${contains(local.privileges_list, "SELECT") || contains(local.privileges_list, "ALL") ? "- Functions: EXECUTE" : ""}
    ${var.create_schema ? "- Schema: CREATE, USAGE" : ""}
    ${var.grant_option ? "- WITH GRANT OPTION enabled (user can grant privileges to others)" : ""}

    Role Attributes:
    ${postgresql_role.user.superuser ? "- SUPERUSER (full database access)" : ""}
    ${postgresql_role.user.create_database ? "- CREATEDB (can create databases)" : ""}
    ${postgresql_role.user.create_role ? "- CREATEROLE (can create other roles)" : ""}
  EOT
}

output "environments" {
  description = "Environment variables map for K8s deployment consumption"
  value = {
    "PLUGIN_POSTGRES_ACCESS_${replace(upper("{{__reference_project_name}}"), "/[^A-Z0-9]/", "_")}_HOST" = {
      value = var.postgres_host
    }
    "PLUGIN_POSTGRES_ACCESS_${replace(upper("{{__reference_project_name}}"), "/[^A-Z0-9]/", "_")}_PORT" = {
      value = tostring(var.postgres_port)
    }
    "PLUGIN_POSTGRES_ACCESS_${replace(upper("{{__reference_project_name}}"), "/[^A-Z0-9]/", "_")}_DATABASE" = {
      value = local.actual_database
    }
    "PLUGIN_POSTGRES_ACCESS_${replace(upper("{{__reference_project_name}}"), "/[^A-Z0-9]/", "_")}_USERNAME" = {
      value = postgresql_role.user.name
    }
    "PLUGIN_POSTGRES_ACCESS_${replace(upper("{{__reference_project_name}}"), "/[^A-Z0-9]/", "_")}_PASSWORD" = {
      value = local.actual_password
    }
    "PLUGIN_POSTGRES_ACCESS_${replace(upper("{{__reference_project_name}}"), "/[^A-Z0-9]/", "_")}_CONNECTION_STRING" = {
      value = "postgresql://${postgresql_role.user.name}:${local.actual_password}@${var.postgres_host}:${var.postgres_port}/${local.actual_database}"
    }
  }
  sensitive = true
}
