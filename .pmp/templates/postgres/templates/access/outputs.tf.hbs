output "role_name" {
  description = "Name of the created PostgreSQL role"
  value       = postgresql_role.user.name
}

output "database_name" {
  description = "Database the role has access to"
  value       = local.actual_database
}

output "schema_name" {
  description = "Schema the role has privileges on"
  value       = var.schema_name
}

output "granted_privileges" {
  description = "Privileges granted to the role"
  value       = local.privileges_list
}

output "connection_limit" {
  description = "Maximum concurrent connections for this role"
  value       = postgresql_role.user.connection_limit
}

output "role_attributes" {
  description = "Role attributes summary"
  value = {
    superuser        = postgresql_role.user.superuser
    create_database  = postgresql_role.user.create_database
    create_role      = postgresql_role.user.create_role
    login            = postgresql_role.user.login
    connection_limit = postgresql_role.user.connection_limit
    valid_until      = postgresql_role.user.valid_until
  }
}

output "connection_string" {
  description = "PostgreSQL connection string (password not included)"
  value       = "postgresql://${postgresql_role.user.name}@{{name}}-postgresql.{{namespace}}.svc.cluster.local:5432/${local.actual_database}"
  sensitive   = false
}

output "jdbc_url" {
  description = "JDBC connection URL"
  value       = "jdbc:postgresql://{{name}}-postgresql.{{namespace}}.svc.cluster.local:5432/${local.actual_database}"
  sensitive   = false
}

output "connection_params" {
  description = "Connection parameters for applications"
  value = {
    host     = "{{name}}-postgresql.{{namespace}}.svc.cluster.local"
    port     = 5432
    database = local.actual_database
    username = postgresql_role.user.name
    schema   = var.schema_name
  }
  sensitive = false
}

{{#if create_k8s_secret}}
output "k8s_secret_name" {
  description = "Name of the Kubernetes secret containing credentials"
  value       = kubernetes_secret.db_credentials.metadata[0].name
}

output "k8s_secret_namespace" {
  description = "Namespace of the Kubernetes secret"
  value       = kubernetes_secret.db_credentials.metadata[0].namespace
}

output "k8s_secret_usage" {
  description = "How to use the Kubernetes secret in your application"
  value = <<-EOT
    # Mount as environment variables:
    env:
      - name: DB_HOST
        valueFrom:
          secretKeyRef:
            name: ${kubernetes_secret.db_credentials.metadata[0].name}
            key: host
      - name: DB_PORT
        valueFrom:
          secretKeyRef:
            name: ${kubernetes_secret.db_credentials.metadata[0].name}
            key: port
      - name: DB_NAME
        valueFrom:
          secretKeyRef:
            name: ${kubernetes_secret.db_credentials.metadata[0].name}
            key: database
      - name: DB_USER
        valueFrom:
          secretKeyRef:
            name: ${kubernetes_secret.db_credentials.metadata[0].name}
            key: username
      - name: DB_PASSWORD
        valueFrom:
          secretKeyRef:
            name: ${kubernetes_secret.db_credentials.metadata[0].name}
            key: password
      - name: DB_CONNECTION_STRING
        valueFrom:
          secretKeyRef:
            name: ${kubernetes_secret.db_credentials.metadata[0].name}
            key: connection-string

    # Or mount as volume:
    volumes:
      - name: db-credentials
        secret:
          secretName: ${kubernetes_secret.db_credentials.metadata[0].name}

    volumeMounts:
      - name: db-credentials
        mountPath: /etc/db-credentials
        readOnly: true
  EOT
}
{{/if}}

output "usage_notes" {
  description = "Important usage information"
  value = <<-EOT
    DATABASE CREDENTIALS CREATED
    ============================

    Role: ${postgresql_role.user.name}
    Database: ${local.actual_database}
    Schema: ${var.schema_name}
    Privileges: ${join(", ", local.privileges_list)}

    CONNECTION INFORMATION:
    - Host: {{name}}-postgresql.{{namespace}}.svc.cluster.local
    - Port: 5432
    - Database: ${local.actual_database}
    - Username: ${postgresql_role.user.name}
    {{#if create_k8s_secret}}- Password: Stored in K8s secret '${kubernetes_secret.db_credentials.metadata[0].name}'{{else}}- Password: Check your configuration or Terraform state{{/if}}

    SECURITY NOTES:
    - This role has ${length(local.privileges_list)} privilege(s) on schema '${var.schema_name}'
    - Connection limit: ${postgresql_role.user.connection_limit == -1 ? "unlimited" : postgresql_role.user.connection_limit}
    {{#if create_k8s_secret}}- Credentials are stored in Kubernetes secret for application use{{/if}}
    - Password expiration: ${var.valid_until != "" ? var.valid_until : "none"}

    CONNECT TO DATABASE:
    # Using psql with port-forward:
    kubectl port-forward -n {{namespace}} svc/{{name}}-postgresql 5432:5432
    {{#if create_k8s_secret}}PGPASSWORD=$(kubectl get secret -n {{namespace}} ${kubernetes_secret.db_credentials.metadata[0].name} -o jsonpath='{.data.password}' | base64 -d) psql -h localhost -p 5432 -U ${postgresql_role.user.name} -d ${local.actual_database}{{else}}psql -h localhost -p 5432 -U ${postgresql_role.user.name} -d ${local.actual_database}{{/if}}

    # From within Kubernetes:
    kubectl run -n {{namespace}} pg-client --rm -it --restart=Never --image=postgres:16 -- {{#if create_k8s_secret}}bash -c "PGPASSWORD=$(kubectl get secret -n {{namespace}} ${kubernetes_secret.db_credentials.metadata[0].name} -o jsonpath='{.data.password}' | base64 -d) psql -h {{name}}-postgresql.{{namespace}}.svc.cluster.local -U ${postgresql_role.user.name} -d ${local.actual_database}"{{else}}psql -h {{name}}-postgresql.{{namespace}}.svc.cluster.local -U ${postgresql_role.user.name} -d ${local.actual_database}{{/if}}
  EOT
}

output "privilege_summary" {
  description = "Summary of granted privileges"
  value = <<-EOT
    Granted Privileges on ${var.schema_name} schema:
    - Tables: ${join(", ", local.privileges_list)}
    ${contains(local.privileges_list, "INSERT") || contains(local.privileges_list, "UPDATE") || contains(local.privileges_list, "ALL") ? "- Sequences: SELECT, UPDATE, USAGE" : ""}
    ${contains(local.privileges_list, "SELECT") || contains(local.privileges_list, "ALL") ? "- Functions: EXECUTE" : ""}
    ${var.create_schema ? "- Schema: CREATE, USAGE" : ""}
    ${var.grant_option ? "- WITH GRANT OPTION enabled (user can grant privileges to others)" : ""}

    Role Attributes:
    ${postgresql_role.user.superuser ? "- SUPERUSER (full database access)" : ""}
    ${postgresql_role.user.create_database ? "- CREATEDB (can create databases)" : ""}
    ${postgresql_role.user.create_role ? "- CREATEROLE (can create other roles)" : ""}
  EOT
}
