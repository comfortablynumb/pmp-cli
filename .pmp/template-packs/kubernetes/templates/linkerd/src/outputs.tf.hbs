output "namespace" {
  description = "Namespace where Linkerd is deployed"
  value       = var.namespace
}

output "release_name" {
  description = "Helm release name for Linkerd control plane"
  value       = helm_release.linkerd_control_plane.name
}

output "chart_version" {
  description = "Linkerd chart version"
  value       = helm_release.linkerd_control_plane.version
}

{{#if install_crds}}
output "crds_installed" {
  description = "Whether Linkerd CRDs were installed"
  value       = true
}

output "crds_release_name" {
  description = "Helm release name for Linkerd CRDs"
  value       = helm_release.linkerd_crds.name
}
{{else}}
output "crds_installed" {
  description = "Whether Linkerd CRDs were installed"
  value       = false
}
{{/if}}

output "trust_domain" {
  description = "Trust domain for mTLS identity"
  value       = var.identity_trust_domain
}

output "ha_enabled" {
  description = "Whether high availability mode is enabled"
  value       = var.ha_enabled
}

output "cni_enabled" {
  description = "Whether CNI plugin is enabled"
  value       = var.cni_enabled
}

output "access_instructions" {
  description = "Instructions for accessing and using Linkerd"
  value       = <<-EOT
    Linkerd service mesh has been deployed to namespace '${var.namespace}'.

    Verify installation:
      linkerd check

    View dashboard:
      linkerd viz dashboard

    Inject proxy into a deployment:
      kubectl get deploy -n <namespace> <deployment-name> -o yaml | linkerd inject - | kubectl apply -f -

    Or enable auto-injection for a namespace:
      kubectl annotate namespace <namespace> linkerd.io/inject=enabled

    Check proxy status:
      linkerd viz stat deploy -n <namespace>

    View live metrics:
      linkerd viz top deploy -n <namespace>

    Tap live traffic:
      linkerd viz tap deploy/<deployment-name> -n <namespace>
  EOT
}

output "kubectl_commands" {
  description = "Useful kubectl commands for managing Linkerd"
  value = <<-EOT
    # Check Linkerd control plane pods
    kubectl get pods -n ${var.namespace}

    # View Linkerd control plane logs
    kubectl logs -n ${var.namespace} -l linkerd.io/control-plane-component=controller

    # Get Linkerd version
    linkerd version

    # Check mesh health
    linkerd check --proxy

    # View meshed workloads
    kubectl get pods --all-namespaces -o jsonpath='{range .items[*]}{@.metadata.namespace}{"\t"}{@.metadata.name}{"\t"}{@.metadata.annotations.linkerd\.io/proxy-version}{"\n"}{end}' | grep -v '<none>'
  EOT
}
