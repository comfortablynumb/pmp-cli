# Template and Plugin Variables

This document describes the variables available in Handlebars templates (`.hbs` files) when rendering templates and plugins in PMP.

## Overview

PMP uses the Handlebars templating engine to render template and plugin files. Variables are made available to templates through a context object that includes user-provided inputs, system-generated values, and inherited values.

## Variable Categories

### 1. User-Defined Inputs

All inputs defined in your template's `.pmp.template.yaml` or plugin's `.pmp.plugin.yaml` are available directly by name.

**Example:**
```yaml
# .pmp.template.yaml
spec:
  inputs:
    database_name:
      default: "mydb"
      description: "Database name"
    replica_count:
      default: 3
      description: "Number of replicas"
```

**Template Usage:**
```hbs
resource "postgresql_database" "main" {
  name = "{{database_name}}"
}

resource "kubernetes_deployment" "app" {
  spec {
    replicas = {{replica_count}}
  }
}
```

### 2. System Variables

These variables are automatically provided by PMP during rendering. All system variables are prefixed with an underscore (`_`) to distinguish them from user-defined inputs:

#### `_name`
- **Type:** String
- **Description:** The project name provided during project creation
- **Available in:** Templates and Plugins
- **Example:** `my-api-service`

```hbs
metadata {
  name = "{{_name}}"
}
```

#### `_environment`
- **Type:** String
- **Description:** The environment name (e.g., dev, staging, prod)
- **Available in:** Templates and Plugins
- **Example:** `dev`

```hbs
resource "kubernetes_namespace" "app" {
  metadata {
    name = "{{_name}}-{{_environment}}"
  }
}
```

#### `_resource_api_version`
- **Type:** String
- **Description:** The apiVersion from the template spec
- **Available in:** Templates only
- **Example:** `pmp.io/v1`

```hbs
# Generated by PMP: {{_resource_api_version}}/{{_resource_kind}}
```

#### `_resource_kind`
- **Type:** String
- **Description:** The resource kind from the template spec
- **Available in:** Templates only
- **Example:** `KubernetesWorkload`

```hbs
# Resource Kind: {{_resource_kind}}
```

### 3. Plugin Variables

When plugins are added to a project, additional variables become available:

#### `_plugins`
- **Type:** Object
- **Description:** Contains information about all added plugins
- **Available in:** Templates only (not available in plugin files themselves)
- **Structure:**
  ```json
  {
    "added": [
      {
        "template_pack_name": "postgres",
        "name": "access",
        "project": {
          "api_version": "pmp.io/v1",
          "kind": "PostgresDatabase",
          "name": "main-db",
          "environment": "dev"
        },
        "reference_project": {
          "api_version": "pmp.io/v1",
          "kind": "PostgresDatabase",
          "name": "main-db",
          "environment": "dev"
        },
        "inputs": {
          "role_name": "app_user",
          "database_name": "myapp"
        },
        "files": ["plugin.tf", "variables.tf", "outputs.tf"]
      }
    ]
  }
  ```

**Template Usage:**
```hbs
{{#if _plugins.added}}
# Plugins
{{#each _plugins.added}}
module "{{template_pack_name}}_{{name}}_{{project.name}}" {
  source = "./modules/{{template_pack_name}}/{{name}}/{{project.name}}"
}
{{/each}}
{{/if}}
```

#### `_plugins.added`
- **Type:** Array
- **Description:** List of all plugins added to this project
- **Available in:** Templates only

```hbs
{{#if _plugins.added}}
output "plugin_count" {
  value = {{_plugins.added.length}}
}
{{/if}}
```

### 4. Plugin-Specific Variables

These variables are only available in plugin templates:

#### `_reference_project_name`
- **Type:** String
- **Description:** Name of the reference project (for plugins that require a reference project)
- **Available in:** Plugins only
- **Example:** `main-database`

```hbs
# Plugin for project: {{_reference_project_name}}
data "terraform_remote_state" "{{_reference_project_name}}" {
  backend = "s3"
  # ...
}
```

### 5. Inherited Variables

Plugins inherit certain values from their parent project:

#### `namespace` (Kubernetes)
- **Type:** String
- **Description:** Kubernetes namespace, inherited from the parent project
- **Available in:** Plugins
- **Inheritance:** Automatically inherited if present in parent project

```hbs
resource "kubernetes_secret" "credentials" {
  metadata {
    name = "{{name}}-credentials"
    namespace = "{{namespace}}"
  }
}
```

#### `database_name` (Database plugins)
- **Type:** String
- **Description:** Database name, inherited from reference project
- **Available in:** Plugins (specifically database access plugins)
- **Inheritance:** Automatically inherited from reference project if empty

```hbs
resource "postgresql_grant" "app_access" {
  database = "{{database_name}}"
  role     = "{{role_name}}"
}
```

## Handlebars Helpers

PMP provides custom Handlebars helpers for common operations:

### `eq` - Equality Comparison
Compare two values for equality.

```hbs
{{#if (eq environment "production")}}
replicas = 5
{{else}}
replicas = 2
{{/if}}
```

### `contains` - Array Contains
Check if an array contains a specific value.

```hbs
{{#if (contains privileges "SELECT")}}
grant_select = true
{{/if}}
```

### `k8s_name` - Kubernetes Name Sanitization
Convert a string to a Kubernetes-compatible DNS subdomain name (RFC 1123).

```hbs
resource "kubernetes_service" "app" {
  metadata {
    name = "{{k8s_name name}}"
  }
}
```

### `bool` - Boolean Conversion
Convert a value to a boolean string ("true" or "false").

```hbs
enable_feature = {{bool enable_monitoring}}
```

## Variable Precedence

When the same variable is defined in multiple places, PMP uses the following precedence order (highest to lowest):

1. **User Input** (provided during create/update)
2. **Collection/Infrastructure Overrides** (from `.pmp.infrastructure.yaml` template configuration)
3. **Environment Overrides** (from template's `spec.environments[env].overrides`)
4. **Template/Plugin Defaults** (from `.pmp.template.yaml` or `.pmp.plugin.yaml`)

## Best Practices

### 1. Use Descriptive Variable Names
```hbs
# Good
database_connection_string = "{{database_host}}:{{database_port}}"

# Avoid
connection = "{{host}}:{{port}}"
```

### 2. Provide Defaults in Template Specs
Always provide sensible defaults in your template/plugin specifications:

```yaml
spec:
  inputs:
    replica_count:
      default: 3
      description: "Number of replicas"
```

### 3. Document Required Variables
Add descriptions to all inputs to help users understand what they're for:

```yaml
spec:
  inputs:
    database_password:
      description: "PostgreSQL database password (leave empty for auto-generated)"
```

### 4. Handle Missing Variables Gracefully
Use conditional blocks to handle optional variables:

```hbs
{{#if description}}
description = "{{description}}"
{{/if}}
```

### 5. Validate Input Types
Use enum values for variables that should only accept specific values:

```yaml
spec:
  inputs:
    environment_type:
      description: "Type of environment"
      enum:
        - development
        - staging
        - production
```

## Example: Complete Template

Here's a complete example showing various variable types:

**`.pmp.template.yaml`:**
```yaml
apiVersion: pmp.io/v1
kind: Template
metadata:
  name: web-app
spec:
  apiVersion: pmp.io/v1
  kind: KubernetesWorkload
  executor: opentofu
  inputs:
    replicas:
      default: 2
      description: "Number of replicas"
    port:
      default: 8080
      description: "Container port"
    image:
      default: "nginx:latest"
      description: "Container image"
```

**`main.tf.hbs`:**
```hbs
# Project: {{_name}}
# Environment: {{_environment}}
# Kind: {{_resource_kind}}

resource "kubernetes_deployment" "{{_name}}" {
  metadata {
    name      = "{{k8s_name _name}}"
    namespace = "{{namespace}}"
    labels = {
      app         = "{{_name}}"
      environment = "{{_environment}}"
    }
  }

  spec {
    replicas = {{replicas}}

    selector {
      match_labels = {
        app = "{{_name}}"
      }
    }

    template {
      metadata {
        labels = {
          app = "{{_name}}"
        }
      }

      spec {
        container {
          name  = "app"
          image = "{{image}}"
          port {
            container_port = {{port}}
          }
        }
      }
    }
  }
}

{{#if _plugins.added}}
# Plugins
{{#each _plugins.added}}
module "{{template_pack_name}}_{{name}}" {
  source = "./modules/{{template_pack_name}}/{{name}}/{{project.name}}"
}
{{/each}}
{{/if}}

resource "kubernetes_service" "{{_name}}" {
  metadata {
    name      = "{{k8s_name _name}}"
    namespace = "{{namespace}}"
  }

  spec {
    selector = {
      app = "{{_name}}"
    }

    port {
      port        = 80
      target_port = {{port}}
    }

    type = {{#if (eq _environment "production")}}"LoadBalancer"{{else}}"ClusterIP"{{/if}}
  }
}
```

## Debugging Templates

To debug template rendering issues:

1. **Check Variable Names:** Ensure variable names in templates match those defined in the spec
2. **Verify Variable Types:** Ensure you're using the correct type (string, number, boolean)
3. **Use Conditional Blocks:** Wrap optional variables in `{{#if}}` blocks
4. **Check Handlebars Syntax:** Ensure proper use of `{{}}` and `{{{}}}` (for unescaped output)
5. **Review Rendered Files:** After project creation, check the generated files in the environment directory

## Additional Resources

- [Handlebars Documentation](https://handlebarsjs.com/)
- [PMP Template Pack Guide](../README.md)
- [Infrastructure Configuration](./infrastructure.md)
